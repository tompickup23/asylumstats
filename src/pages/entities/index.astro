---
import BaseLayout from "../../layouts/BaseLayout.astro";
import DataDrawer from "../../components/DataDrawer.astro";
import PageContents from "../../components/PageContents.astro";
import PageGuide from "../../components/PageGuide.astro";
import {
  formatEntityRoleLabel,
  formatRouteFamilyLabel,
  getEntityProfiles
} from "../../lib/entities";
import { getEntityRegionalContractCoverage, getEntityTimeline } from "../../lib/entity-analytics";
import { loadHotelEntityLedger } from "../../lib/hotel-data";
import { loadLocalRouteLatest } from "../../lib/route-data";

const entityProfiles = getEntityProfiles();
const hotelLedger = loadHotelEntityLedger();
const localRouteLatest = loadLocalRouteLatest();
const entityExplorerProfiles = entityProfiles.map((profile) => ({
  profile,
  timeline: getEntityTimeline(profile, 8),
  regionalCoverage: getEntityRegionalContractCoverage(profile, localRouteLatest.areas, hotelLedger.areas, 5)
}));
const featuredProfiles = entityProfiles.slice(0, 4);
const hotelLinkedProfiles = entityProfiles.filter((profile) => profile.currentSiteCount > 0);
const publicBodyProfiles = entityProfiles.filter((profile) => profile.primaryRole === "public_body");
const entityRoleOptions = [...new Set(entityProfiles.map((profile) => profile.primaryRole))].sort((left, right) =>
  formatEntityRoleLabel(left).localeCompare(formatEntityRoleLabel(right))
);
const entityRouteOptions = [...new Set(entityProfiles.flatMap((profile) => profile.routeFamilies))].sort((left, right) =>
  formatRouteFamilyLabel(left).localeCompare(formatRouteFamilyLabel(right))
);
const uniqueCurrentSiteCount = new Set(hotelLinkedProfiles.flatMap((profile) => profile.currentSites.map((site) => site.siteId)))
  .size;
const uniqueMoneyRowCount = new Set(entityProfiles.flatMap((profile) => profile.moneyRecords.map((record) => record.recordId)))
  .size;
const uniqueAreaCount = new Set(
  hotelLinkedProfiles.flatMap((profile) => profile.linkedAreas.map((area) => area.areaCode ?? area.areaName))
).size;
const datedEvidenceProfileCount = entityExplorerProfiles.filter(
  ({ timeline }) => timeline.firstEvidenceDate || timeline.latestEvidenceDate
).length;
const regionalCoverageProfileCount = entityExplorerProfiles.filter(({ regionalCoverage }) => regionalCoverage !== null).length;
const entityFindingCards = [
  featuredProfiles[0]
    ? {
        title: "Named entities now sit on the main accountability surface",
        body: `${featuredProfiles[0].entityName} already links ${featuredProfiles[0].currentSiteCount} current named site${featuredProfiles[0].currentSiteCount === 1 ? "" : "s"} to ${featuredProfiles[0].moneyRecordCount} public money row${featuredProfiles[0].moneyRecordCount === 1 ? "" : "s"}.`
      }
    : null,
  hotelLinkedProfiles.length > 0
    ? {
        title: "Owner and operator visibility is still thinner than provider visibility",
        body: `${hotelLinkedProfiles.length} profiles already touch named current hotel sites, but several of those sites still sit under partial or unresolved chain coverage.`
      }
    : null,
  publicBodyProfiles[0]
    ? {
        title: "Some entity pages are funding surfaces rather than hotel chains",
        body: `${publicBodyProfiles[0].entityName} carries ${publicBodyProfiles[0].moneyRecordCount} money rows across ${publicBodyProfiles[0].routeFamilies.map(formatRouteFamilyLabel).join(", ")} without sitting on a named hotel estate.`
      }
    : null
].filter((card): card is { title: string; body: string } => card !== null);

function buildPresetHref(pathname: string, params: Record<string, string>, hash: string): string {
  return `${pathname}?${new URLSearchParams(params).toString()}#${hash}`;
}

const entityPresetViews = [
  {
    title: "Newest public evidence",
    body: "Sort the entity field by the most recent public signal so the newest named actors and latest money trails rise to the top.",
    href: buildPresetHref(
      "/entities/",
      {
        entity_surface: "dated_evidence",
        entity_sort: "newest",
        entity_limit: "12"
      },
      "entity-explorer"
    ),
    cta: "Open newest evidence"
  },
  {
    title: "Oldest visible chains",
    body: "Keep named-estate actors only and rank them by the oldest surviving public evidence, so long-running chains surface first.",
    href: buildPresetHref(
      "/entities/",
      {
        entity_surface: "named_chain",
        entity_footprint: "named_estate",
        entity_sort: "oldest",
        entity_limit: "12"
      },
      "entity-explorer"
    ),
    cta: "Open oldest chains"
  },
  {
    title: "Widest regional providers",
    body: "Jump straight to the prime providers whose published regional contract field covers the most local authorities.",
    href: buildPresetHref(
      "/entities/",
      {
        entity_role: "prime_provider",
        entity_surface: "regional_provider",
        entity_sort: "regional",
        entity_limit: "12"
      },
      "entity-explorer"
    ),
    cta: "Open regional providers"
  },
  {
    title: "Prime providers on the named estate",
    body: "Jump straight to prime providers that already touch current named hotel sites and rank them by estate footprint.",
    href: buildPresetHref(
      "/entities/",
      {
        entity_role: "prime_provider",
        entity_footprint: "named_estate",
        entity_sort: "estate",
        entity_limit: "12"
      },
      "entity-explorer"
    ),
    cta: "Open prime providers"
  },
  {
    title: "Ownership and operator chain links",
    body: "Pull the owner-group, freeholder, brand-operator, operator, and hotel-operator profiles into one visible ledger by searching the named estate only.",
    href: buildPresetHref(
      "/entities/",
      {
        entity_q: "hotel owner operator freeholder group",
        entity_footprint: "named_estate",
        entity_sort: "estate",
        entity_limit: "24"
      },
      "entity-explorer"
    ),
    cta: "Open ownership chain"
  },
  {
    title: "Money-only public-body surfaces",
    body: "Keep the funding and tariff actors together, without the hotel-linked profiles crowding them out.",
    href: buildPresetHref(
      "/entities/",
      {
        entity_role: "public_body",
        entity_footprint: "money_only",
        entity_sort: "money",
        entity_limit: "12"
      },
      "entity-explorer"
    ),
    cta: "Open public bodies"
  },
  {
    title: "Unresolved estate exposure",
    body: "Move straight to profiles whose current named sites still sit inside unresolved or partial chain coverage.",
    href: buildPresetHref(
      "/entities/",
      {
        entity_footprint: "unresolved_estate",
        entity_sort: "exposure",
        entity_limit: "12"
      },
      "entity-explorer"
    ),
    cta: "Open unresolved exposure"
  }
];
const entityGuideItems = [
  {
    eyebrow: "Start here",
    title: "Open the priority actor profiles first",
    body: "Use the featured profiles as the fastest route into the named providers, owner groups, and public bodies already carrying the strongest public evidence.",
    href: "#priority-entities",
    cta: "Open priority profiles"
  },
  {
    eyebrow: "Then check",
    title: "Use presets before free filtering",
    body: "The preset views answer common questions quickly: newest actors, oldest visible chains, regional providers, and money-only public bodies.",
    href: "#entity-presets",
    cta: "Open preset views"
  },
  {
    eyebrow: "Only if needed",
    title: "Use the full explorer to verify or widen the field",
    body: "The full entity explorer, named-estate list, and funding surfaces matter when you need completeness, but they should not be the first thing a reader faces.",
    href: "#entity-data",
    cta: "Open the deep data"
  }
];
const entitySections = [
  { id: "entity-findings", label: "Findings" },
  { id: "entity-guide", label: "How to use" },
  { id: "priority-entities", label: "Priority profiles" },
  { id: "entity-presets", label: "Presets" },
  { id: "entity-data", label: "Explorer + lists" }
];

function formatMoney(value: number | null | undefined): string {
  if (typeof value !== "number") {
    return "Not disclosed / not normalized";
  }

  return new Intl.NumberFormat("en-GB", {
    style: "currency",
    currency: "GBP",
    maximumFractionDigits: value >= 1000 ? 0 : 2
  }).format(value);
}

function formatEvidenceDate(value: string | null | undefined): string {
  if (!value) {
    return "No dated evidence";
  }

  return new Intl.DateTimeFormat("en-GB", {
    month: "short",
    year: "numeric"
  }).format(new Date(`${value}T00:00:00Z`));
}
---

<BaseLayout
  title="Entities | asylumstats"
  description="Named provider, owner-group, operator, and public-body profiles tied to the visible hotel estate, money rows, and local pressure."
>
  <section class="page-top">
    <section class="page-head">
      <span class="kicker">Entities</span>
      <h1>Track the named actors behind hotels, contracts, and local pressure.</h1>
      <p>
        This page turns scattered supplier, owner, operator, and public-body references into readable actor profiles.
        Start with the strongest public actors, then widen out only if you need the full profile field.
      </p>
    </section>

    <aside class="page-rail">
      <article class="panel panel-pad">
        <span class="tiny">Entity surface</span>
        <div class="stat-strip">
          <article class="stat-tile">
            <span class="tiny">Profiles tracked</span>
            <strong>{entityProfiles.length.toLocaleString()}</strong>
            <p class="tiny">Visible named actors in the live starter ledgers.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Current named sites</span>
            <strong>{uniqueCurrentSiteCount.toLocaleString()}</strong>
            <p class="tiny">Unique current named hotels tied to at least one profile.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Public money rows</span>
            <strong>{uniqueMoneyRowCount.toLocaleString()}</strong>
            <p class="tiny">Unique money rows already attached to entity pages.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Linked places</span>
            <strong>{uniqueAreaCount.toLocaleString()}</strong>
            <p class="tiny">Local areas with visible entity-to-place links.</p>
          </article>
        </div>
      </article>
    </aside>
  </section>

  <PageContents title="Start here" sections={entitySections} variant="priority" />

  <section id="entity-findings" class="section section-anchor priority-section">
    <div class="section-head">
      <div>
        <h2>What matters first</h2>
        <p class="lede">
          The visible estate is no longer just a hotel list. It now has named actors behind it, direct money rows for
          some of them, and clear gaps where the chain is still only partially resolved.
        </p>
      </div>
      <span class="chip accent">{entityProfiles.length} public profiles</span>
    </div>
    <div class="story-grid">
      {entityFindingCards.map((card) => (
        <article class="story-card">
          <h3>{card.title}</h3>
          <p class="lede">{card.body}</p>
        </article>
      ))}
    </div>
  </section>

  <PageGuide
    id="entity-guide"
    title="Use the entity page in three moves"
    intro="This page should make named actors legible quickly, not ask the reader to decode the whole profile universe at once."
    items={entityGuideItems}
  />

  <section id="priority-entities" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Priority profiles</h2>
        <p class="lede">
          These are the fastest routes into the strongest named-actor evidence already on the site.
        </p>
      </div>
    </div>
    <div class="feature-grid">
      {featuredProfiles.map((profile) => (
        <article class="feature-card accent">
          <div class="chip-row">
            <span class="chip accent">{profile.primaryRoleLabel}</span>
            <span class="chip">{profile.roleSummary}</span>
            {profile.riskLevel && <span class="chip">{profile.riskLevel}</span>}
          </div>
          <h3>{profile.entityName}</h3>
          <p class="metric-value">{profile.currentSiteCount.toLocaleString()}</p>
          <p class="lede">Current named site{profile.currentSiteCount === 1 ? "" : "s"} already attached to this profile.</p>
          <div class="data-list">
            <div class="data-row">
              <span>Public money rows</span>
              <span class="data-row-value">{profile.moneyRecordCount.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Linked places</span>
              <span class="data-row-value">{profile.linkedAreaCount.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Published value</span>
              <span class="data-row-value">{formatMoney(profile.publicContractValueGbp)}</span>
            </div>
          </div>
          <p class="tiny">
            <a class="source-pill" href={`/entities/${profile.entityId}/`}>Open entity profile</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section id="entity-presets" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Deep-link presets</h2>
        <p class="lede">
          These saved views jump straight into the most useful cuts of the entity surface instead of making users rebuild the same filters manually.
        </p>
      </div>
      <span class="chip accent">Deep-link presets</span>
    </div>
    <div class="story-grid">
      {entityPresetViews.map((preset) => (
        <article class="story-card">
          <h3>{preset.title}</h3>
          <p class="lede">{preset.body}</p>
          <p class="tiny">
            <a class="source-pill" href={preset.href}>{preset.cta}</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <DataDrawer
    id="entity-data"
    label="Deep data"
    title="Open the full explorer, named-estate list, and funding surfaces"
    summary="Once the priority actors and presets are clear, use this section to filter the full profile field and inspect the wider named-estate and money-only surfaces."
  >
  <section id="entity-explorer" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Explorer and full profile ledger</h2>
        <p class="lede">
          This explorer keeps the entity state in the URL, so the exact provider, owner, or public-body slice can be shared.
        </p>
      </div>
      <div class="chip-row">
        <span class="chip" data-entity-summary aria-live="polite">Showing {Math.min(12, entityProfiles.length)} of {entityProfiles.length} matching profiles</span>
        <span class="chip teal" data-entity-estate-summary aria-live="polite">{hotelLinkedProfiles.length} with a current named estate</span>
        <span class="chip warm" data-entity-money-summary aria-live="polite">{entityProfiles.filter((profile) => profile.moneyRecordCount > 0).length} with public money rows</span>
        <span class="chip" data-entity-timeline-summary aria-live="polite">{datedEvidenceProfileCount} with dated evidence, {regionalCoverageProfileCount} with regional contract coverage</span>
      </div>
    </div>
    <form class="filter-panel" data-entity-form>
      <div class="filter-grid">
        <label class="filter-field">
          <span class="tiny">Search entity, site, or place</span>
          <input type="search" name="entity_q" placeholder="Search Serco, Bell Hotel, or Epping Forest" />
        </label>
        <label class="filter-field">
          <span class="tiny">Primary role</span>
          <select name="entity_role">
            <option value="all">All roles</option>
            {entityRoleOptions.map((role) => (
              <option value={role}>{formatEntityRoleLabel(role)}</option>
            ))}
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Route family</span>
          <select name="entity_route">
            <option value="all">All route families</option>
            {entityRouteOptions.map((routeFamily) => (
              <option value={routeFamily}>{formatRouteFamilyLabel(routeFamily)}</option>
            ))}
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Evidence surface</span>
          <select name="entity_surface">
            <option value="all">All surfaces</option>
            <option value="dated_evidence">Dated public evidence</option>
            <option value="named_chain">Visible site chains</option>
            <option value="regional_provider">Regional contract providers</option>
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Footprint</span>
          <select name="entity_footprint">
            <option value="all">All footprints</option>
            <option value="named_estate">Named estate only</option>
            <option value="money_only">Money-only surfaces</option>
            <option value="unresolved_estate">Unresolved estate exposure</option>
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Sort</span>
          <select name="entity_sort">
            <option value="exposure">Exposure</option>
            <option value="estate">Estate footprint</option>
            <option value="money">Money rows</option>
            <option value="newest">Newest evidence</option>
            <option value="oldest">Oldest evidence</option>
            <option value="regional">Regional coverage</option>
            <option value="title">Alphabetical</option>
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Show</span>
          <select name="entity_limit">
            <option value="12">12 profiles</option>
            <option value="24">24 profiles</option>
            <option value="99">All profiles</option>
          </select>
        </label>
      </div>
      <div class="filter-actions">
        <button type="button" class="source-pill" data-entity-reset>Reset filters</button>
        <button type="button" class="source-pill" data-entity-copy>Copy filtered view</button>
        <span class="tiny filter-status" data-entity-copy-status aria-live="polite"></span>
      </div>
    </form>
    <div class="story-grid" data-entity-results>
      {entityExplorerProfiles.map(({ profile, timeline, regionalCoverage }) => (
        <article
          class="story-card"
          data-entity-item
          data-entity-id={profile.entityId}
          data-name={profile.entityName}
          data-role={profile.primaryRole}
          data-routes={profile.routeFamilies.join("|")}
          data-current-sites={profile.currentSiteCount}
          data-money-rows={profile.moneyRecordCount}
          data-linked-areas={profile.linkedAreaCount}
          data-unresolved-sites={profile.unresolvedCurrentSiteCount}
          data-rows-with-value={profile.moneyRowsWithPublishedValueCount}
          data-first-evidence-date={timeline.firstEvidenceDate ?? undefined}
          data-latest-evidence-date={timeline.latestEvidenceDate ?? undefined}
          data-regional-areas={regionalCoverage?.coveredAreaCount ?? 0}
          data-named-coverage-areas={regionalCoverage?.namedCurrentAreaCount ?? 0}
          data-score={profile.score}
          data-search={[
            profile.entityName,
            profile.primaryRoleLabel,
            profile.roleLabels.join(" "),
            profile.routeFamilies.map(formatRouteFamilyLabel).join(" "),
            profile.currentSites.map((site) => site.siteName).join(" "),
            profile.linkedAreas.map((area) => area.areaName).join(" "),
            profile.searchDescription
          ]
            .join(" ")
            .toLowerCase()}
          hidden={entityProfiles.indexOf(profile) >= 12}
        >
          <div class="chip-row">
            <span class="chip accent">{profile.primaryRoleLabel}</span>
            <span class="chip">{profile.roleSummary}</span>
            {profile.riskLevel && <span class="chip">{profile.riskLevel}</span>}
          </div>
          <h3>{profile.entityName}</h3>
          <p class="lede">{profile.searchDescription}</p>
          <div class="data-list">
            <div class="data-row">
              <span>Current named sites</span>
              <span class="data-row-value">{profile.currentSiteCount.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Public money rows</span>
              <span class="data-row-value">{profile.moneyRecordCount.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Linked places</span>
              <span class="data-row-value">{profile.linkedAreaCount.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Latest evidence</span>
              <span class="data-row-value">{formatEvidenceDate(timeline.latestEvidenceDate)}</span>
            </div>
            <div class="data-row">
              <span>Regional contract areas</span>
              <span class="data-row-value">{regionalCoverage?.coveredAreaCount?.toLocaleString() ?? "None"}</span>
            </div>
          </div>
          <p class="tiny">
            First visible evidence: {formatEvidenceDate(timeline.firstEvidenceDate)}.{" "}
            {profile.routeFamilies.map(formatRouteFamilyLabel).join(", ") || "No route family attached"}
          </p>
          <p class="tiny">
            <a class="source-pill" href={`/entities/${profile.entityId}/`}>Open entity profile</a>
          </p>
        </article>
      ))}
    </div>
    <article class="editor-note" data-entity-empty hidden>
      <h3>No entity profiles match these filters</h3>
      <p>Reset the filters or widen the role, route, and footprint scope to bring entity profiles back into view.</p>
    </article>
  </section>

  <section id="visible-estate" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Profiles already touching the named estate</h2>
        <p class="lede">
          These actors already sit on named current hotel sites, which means the chain can be investigated from site to
          place to money row.
        </p>
      </div>
    </div>
    <div class="story-grid">
      {hotelLinkedProfiles.map((profile) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip accent">{profile.primaryRoleLabel}</span>
            <span class="chip">{profile.currentSiteCount} current site{profile.currentSiteCount === 1 ? "" : "s"}</span>
          </div>
          <h3>{profile.entityName}</h3>
          <p class="lede">
            {profile.currentSites.map((site) => site.siteName).join(", ")}
          </p>
          <p class="tiny">
            Areas: {profile.linkedAreas.map((area) => area.areaName).join(", ")}
          </p>
          <p class="tiny">
            <a class="source-pill" href={`/entities/${profile.entityId}/`}>Open entity profile</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section id="funding-surfaces" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Money-led funding surfaces</h2>
        <p class="lede">
          Not every entity page is a hotel chain. Some are where public funding instructions and buyer control sit in
          the open.
        </p>
      </div>
    </div>
    <div class="feature-grid">
      {entityProfiles
        .filter((profile) => profile.moneyRecordCount > 0)
        .map((profile) => (
          <article class="feature-card teal">
            <div class="chip-row">
              <span class="chip teal">{profile.primaryRoleLabel}</span>
              <span class="chip">{profile.moneyRecordCount} money row{profile.moneyRecordCount === 1 ? "" : "s"}</span>
            </div>
            <h3>{profile.entityName}</h3>
            <p class="lede">{profile.routeFamilies.map(formatRouteFamilyLabel).join(", ") || "No route families attached"}</p>
            <div class="data-list">
              <div class="data-row">
                <span>Rows with published values</span>
                <span class="data-row-value">{profile.moneyRowsWithPublishedValueCount.toLocaleString()}</span>
              </div>
              <div class="data-row">
                <span>Published value</span>
                <span class="data-row-value">{formatMoney(profile.publicContractValueGbp)}</span>
              </div>
            </div>
            <p class="tiny">
              <a class="source-pill" href={`/entities/${profile.entityId}/`}>Open entity profile</a>
            </p>
          </article>
      ))}
    </div>
  </section>
  </DataDrawer>

  <script>
    import { initEntityExplorer } from "../../scripts/entity-explorer";

    initEntityExplorer();
  </script>
</BaseLayout>

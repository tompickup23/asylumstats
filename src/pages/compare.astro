---
import BaseLayout from "../layouts/BaseLayout.astro";
import BenchmarkStrip from "../components/BenchmarkStrip.astro";
import PathwayMixCard from "../components/PathwayMixCard.astro";
import RegionTileMap from "../components/RegionTileMap.astro";
import { loadLocalRouteLatest } from "../lib/route-data";
import { getDistributionStats, getPercentileRank, getRegionPressureSummaries } from "../lib/route-analytics";

const localRouteLatest = loadLocalRouteLatest();
type ComparePlace = (typeof localRouteLatest.areas)[number];
const comparePlaces = localRouteLatest.defaultCompareCodes
  .map((code) => localRouteLatest.areas.find((place) => place.areaCode === code))
  .filter((place): place is ComparePlace => place !== undefined);
const maxSupported = Math.max(...comparePlaces.map((row) => row.supportedAsylum), 1);
const maxAllPathways = Math.max(...comparePlaces.map((row) => row.allThreePathwaysTotal), 1);
const supportedLeader = [...comparePlaces].sort((a, b) => b.supportedAsylum - a.supportedAsylum)[0];
const supportedRateLeader = [...comparePlaces].sort(
  (a, b) => (b.supportedAsylumRate ?? 0) - (a.supportedAsylumRate ?? 0)
)[0];
const contingencyLeader = [...comparePlaces].sort(
  (a, b) => b.contingencyAccommodation - a.contingencyAccommodation
)[0];
const pathwayLeader = [...comparePlaces].sort((a, b) => b.allThreePathwaysTotal - a.allThreePathwaysTotal)[0];
const supportedStats = getDistributionStats(localRouteLatest.areas.map((place) => place.supportedAsylum));
const supportedRateStats = getDistributionStats(
  localRouteLatest.areas.map((place) => place.supportedAsylumRate ?? 0)
);
const contingencyStats = getDistributionStats(
  localRouteLatest.areas.map((place) => place.contingencyAccommodation)
);
const compareRegions = [...new Set(comparePlaces.map((place) => place.regionName))];
const regionalPressure = getRegionPressureSummaries(localRouteLatest.areas);
const compareExplorerRegions = [...new Set(localRouteLatest.areas.map((place) => place.regionName))].sort();
const compareExplorerCountries = [...new Set(localRouteLatest.areas.map((place) => place.countryName))].sort();
const compareProfiles = comparePlaces.map((place) => {
  const contingencySharePct = place.supportedAsylum
    ? Number(((place.contingencyAccommodation / place.supportedAsylum) * 100).toFixed(1))
    : 0;
  const humanitarianTotal = place.homesForUkraineArrivals + place.afghanProgrammePopulation;

  return {
    place,
    humanitarianTotal,
    contingencySharePct,
    supportedPercentile: getPercentileRank(
      localRouteLatest.areas.map((candidate) => candidate.supportedAsylum),
      place.supportedAsylum
    ),
    supportedRatePercentile: getPercentileRank(
      localRouteLatest.areas.map((candidate) => candidate.supportedAsylumRate ?? 0),
      place.supportedAsylumRate ?? 0
    ),
    contingencyPercentile: getPercentileRank(
      localRouteLatest.areas.map((candidate) => candidate.contingencyAccommodation),
      place.contingencyAccommodation
    )
  };
});
const compareExplorerItems = [...localRouteLatest.areas]
  .sort((a, b) => b.supportedAsylum - a.supportedAsylum || a.areaName.localeCompare(b.areaName))
  .map((place) => {
    const humanitarianTotal = place.homesForUkraineArrivals + place.afghanProgrammePopulation;
    const contingencySharePct = place.supportedAsylum
      ? Number(((place.contingencyAccommodation / place.supportedAsylum) * 100).toFixed(1))
      : 0;
    const primaryModel =
      contingencySharePct >= 35
        ? "hotel-heavy"
        : humanitarianTotal >= place.supportedAsylum * 0.5
          ? "humanitarian-heavy"
          : contingencySharePct <= 10
            ? "dispersal-led"
            : "balanced";

    return {
      place,
      humanitarianTotal,
      contingencySharePct,
      primaryModel
    };
  });
const humanitarianLeader = [...compareProfiles].sort((a, b) => b.humanitarianTotal - a.humanitarianTotal)[0];
const compareEditorialCards = [
  supportedLeader && supportedRateLeader
    ? {
        title: "Count and rate split apart immediately",
        body: `${supportedLeader.areaName} has the highest supported asylum count in this set, while ${supportedRateLeader.areaName} has the highest rate per 10,000 residents. The busiest place is not automatically the most intense one.`
      }
    : null,
  contingencyLeader
    ? {
        title: "Contingency pressure is concentrated, not evenly spread",
        body: `${contingencyLeader.areaName} leads this set on contingency accommodation, which is why hotel-heavy pressure has to be read separately from dispersal-heavy places like Glasgow City.`
      }
    : null,
  pathwayLeader && humanitarianLeader
    ? {
        title: "Humanitarian pathway load changes the local reading",
        body: `${pathwayLeader.areaName} has the largest three-pathway total, but ${humanitarianLeader.place.areaName} carries the biggest combined Homes for Ukraine and Afghan programme population in this compare set.`
      }
    : null
].filter((card): card is { title: string; body: string } => card !== null);
const compareMatrixRows = [
  {
    label: "Supported asylum",
    note: "People on asylum support",
    format: (place: ComparePlace) => place.supportedAsylum.toLocaleString()
  },
  {
    label: "Supported asylum rate",
    note: "Per 10,000 residents",
    format: (place: ComparePlace) =>
      place.supportedAsylumRate !== null ? place.supportedAsylumRate.toLocaleString() : "n/a"
  },
  {
    label: "Contingency accommodation",
    note: "Hotel and other contingency placements",
    format: (place: ComparePlace) => place.contingencyAccommodation.toLocaleString()
  },
  {
    label: "Homes for Ukraine arrivals",
    note: "Recorded arrivals",
    format: (place: ComparePlace) => place.homesForUkraineArrivals.toLocaleString()
  },
  {
    label: "Afghan programme population",
    note: "Current stock",
    format: (place: ComparePlace) => place.afghanProgrammePopulation.toLocaleString()
  },
  {
    label: "All three pathways total",
    note: "Supported asylum plus Afghan and Ukraine pathways",
    format: (place: ComparePlace) => place.allThreePathwaysTotal.toLocaleString()
  },
  {
    label: "Share of population",
    note: "Percent of population across three pathways",
    format: (place: ComparePlace) =>
      place.shareOfPopulationPct !== null ? `${place.shareOfPopulationPct.toLocaleString()}%` : "n/a"
  },
  {
    label: "Resettlement cumulative total",
    note: "Historical resettlement and family reunion flow",
    format: (place: ComparePlace) => place.resettlementCumulativeTotal.toLocaleString()
  }
];
---

<BaseLayout
  title="Compare | asylumstats"
  description="Compare local asylum support, contingency accommodation, Ukraine arrivals, Afghan pathways, and place-level route pressure."
>
  <section class="page-top">
    <section class="page-head">
      <span class="kicker">Compare</span>
      <h1>Area comparison should show route mix, intensity, and accommodation model in the same frame.</h1>
      <p>
        This view uses the official local-authority snapshot as at 31 December 2025, plus cumulative resettlement
        history from the local authority resettlement dataset. The compare page now starts with composition and
        benchmarks so the table lands after the story is already visible.
      </p>
    </section>

    <aside class="page-rail">
      <article class="panel panel-pad">
        <span class="tiny">Compare set</span>
        <p class="rail-copy">
          These places show different route mixes, different rates, and very different contingency exposure. That is
          exactly why they belong on one comparison surface.
        </p>
        <div class="stat-strip">
          {supportedLeader && (
            <article class="stat-tile">
              <span class="tiny">Highest supported asylum count</span>
              <strong>{supportedLeader.supportedAsylum.toLocaleString()}</strong>
              <p class="tiny">{supportedLeader.areaName}</p>
            </article>
          )}
          {supportedRateLeader && (
            <article class="stat-tile">
              <span class="tiny">Highest supported asylum rate</span>
              <strong>{supportedRateLeader.supportedAsylumRate?.toLocaleString() ?? "n/a"}</strong>
              <p class="tiny">{supportedRateLeader.areaName}</p>
            </article>
          )}
          {contingencyLeader && (
            <article class="stat-tile">
              <span class="tiny">Highest contingency count</span>
              <strong>{contingencyLeader.contingencyAccommodation.toLocaleString()}</strong>
              <p class="tiny">{contingencyLeader.areaName}</p>
            </article>
          )}
        </div>
      </article>

      <article class="panel panel-pad">
        <span class="tiny">Snapshot date</span>
        <h2 class="rail-title">{localRouteLatest.snapshotDate}</h2>
        <p class="rail-copy">
          Count, rate, and pathway composition now stay in the same frame instead of forcing users to infer the local
          model from one headline number.
        </p>
      </article>
    </aside>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Default compare set</h2>
        <p class="lede">
          Each card keeps the main pathways together so hotel-heavy areas and dispersal-heavy areas can be read in
          context.
        </p>
      </div>
      <span class="chip">{comparePlaces.length} places in the default view</span>
    </div>
    <div class="feature-grid">
      {comparePlaces.map((place) => (
        <article class="feature-card">
          <div class="chip-row">
            <span class="chip">{place.regionName}</span>
            <span class="chip teal">{place.countryName}</span>
          </div>
          <h3>{place.areaName}</h3>
          <p class="metric-value">{place.supportedAsylum.toLocaleString()}</p>
          <p class="lede">Supported asylum population as at {localRouteLatest.snapshotDate}.</p>
          <div class="data-list">
            <div class="data-row">
              <span>Supported asylum rate</span>
              <span class="data-row-value">{place.supportedAsylumRate ?? "n/a"} per 10,000</span>
            </div>
            <div class="data-row">
              <span>Contingency accommodation</span>
              <span class="data-row-value">{place.contingencyAccommodation.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Homes for Ukraine arrivals</span>
              <span class="data-row-value">{place.homesForUkraineArrivals.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Afghan programme population</span>
              <span class="data-row-value">{place.afghanProgrammePopulation.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>All three pathways total</span>
              <span class="data-row-value">{place.allThreePathwaysTotal.toLocaleString()}</span>
            </div>
          </div>
          <p class="tiny">
            <a class="source-pill" href={`/places/${place.areaCode}/`}>Open place page</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Pathway mix profiles</h2>
        <p class="lede">
          Each compare place now shows the relative scale of supported asylum, Homes for Ukraine, and Afghan programme
          population, with contingency pressure called out separately inside the asylum layer.
        </p>
      </div>
    </div>
    <div class="viz-grid">
      {compareProfiles.map((profile) => (
        <PathwayMixCard
          title={profile.place.areaName}
          description={`${profile.place.regionName}. Supported asylum count sits around the ${profile.supportedPercentile}th percentile nationally.`}
          segments={[
            {
              label: "Supported asylum",
              value: profile.place.supportedAsylum,
              tone: "accent",
              detail: `${profile.place.supportedAsylumRate ?? "n/a"} per 10,000`
            },
            {
              label: "Homes for Ukraine",
              value: profile.place.homesForUkraineArrivals,
              tone: "teal",
              detail: `${profile.place.homesForUkraineRate ?? "n/a"} per 10,000`
            },
            {
              label: "Afghan programme",
              value: profile.place.afghanProgrammePopulation,
              tone: "warm",
              detail: `${profile.place.afghanProgrammeRate ?? "n/a"} per 10,000`
            }
          ]}
          note={
            profile.place.contingencyAccommodation > 0
              ? `${profile.place.contingencyAccommodation.toLocaleString()} people are in contingency accommodation here, about ${profile.contingencySharePct}% of the supported asylum population.`
              : "No contingency accommodation is recorded here in the current local-authority snapshot."
          }
        />
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>National benchmark frame</h2>
        <p class="lede">
          Raw counts alone flatten the picture. These strips show where each place sits in the full national
          distribution for count, rate, and contingency pressure.
        </p>
      </div>
    </div>
    <div class="feature-grid">
      {compareProfiles.map((profile) => (
        <article class="feature-card accent">
          <div class="chip-row">
            <span class="chip accent">{profile.supportedPercentile}th percentile by count</span>
            <span class="chip teal">{profile.supportedRatePercentile}th percentile by rate</span>
            <span class="chip">{profile.contingencyPercentile}th percentile by contingency</span>
          </div>
          <h3>{profile.place.areaName}</h3>
          <p class="lede">
            This is what keeps volume, intensity, and hotel-heavy pressure separate for the same place.
          </p>
          <div class="benchmark-grid">
            <BenchmarkStrip
              label="Supported asylum count"
              value={profile.place.supportedAsylum}
              min={supportedStats.min}
              median={supportedStats.median}
              p90={supportedStats.p90}
              max={supportedStats.max}
              valueLabel={profile.place.supportedAsylum.toLocaleString()}
            />
            <BenchmarkStrip
              label="Supported asylum rate"
              value={profile.place.supportedAsylumRate ?? 0}
              min={supportedRateStats.min}
              median={supportedRateStats.median}
              p90={supportedRateStats.p90}
              max={supportedRateStats.max}
              valueLabel={profile.place.supportedAsylumRate !== null ? `${profile.place.supportedAsylumRate}` : "n/a"}
              tone="teal"
            />
            <BenchmarkStrip
              label="Contingency accommodation"
              value={profile.place.contingencyAccommodation}
              min={contingencyStats.min}
              median={contingencyStats.median}
              p90={contingencyStats.p90}
              max={contingencyStats.max}
              valueLabel={profile.place.contingencyAccommodation.toLocaleString()}
              tone="warm"
            />
          </div>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Regional pressure field</h2>
        <p class="lede">
          The four compare places sit inside wider regional concentration patterns. Highlighting their regions stops the
          compare set from floating free of the national map.
        </p>
      </div>
      <span class="chip">{compareRegions.length} regions represented</span>
    </div>
    <div class="viz-grid">
      <RegionTileMap
        items={regionalPressure.map((region) => ({ regionName: region.regionName, value: region.supportedAsylum }))}
        title="Supported asylum by region"
        description="The compare-set regions are highlighted on the national regional total map."
        valueLabel="total people"
        highlightRegions={compareRegions}
      />
      <RegionTileMap
        items={regionalPressure.map((region) => ({ regionName: region.regionName, value: region.supportedAsylumRate }))}
        title="Supported asylum rate by region"
        description="Regional rates show where smaller populations carry sharper pressure."
        valueLabel="rate per 10,000"
        highlightRegions={compareRegions}
        tone="teal"
      />
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Cross-place matrix</h2>
        <p class="lede">
          This matrix keeps the headline pathway measures in one place so the comparison stays concrete instead of
          rhetorical.
        </p>
      </div>
    </div>
    <div class="table-card">
      <table class="matrix-table">
        <caption>Cross-place matrix for the default compare set covering counts, rates, and pathway composition.</caption>
        <thead>
          <tr>
            <th scope="col">Metric</th>
            {comparePlaces.map((place) => (
              <th scope="col">{place.areaName}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {compareMatrixRows.map((row) => (
            <tr>
              <th scope="row">
                <strong>{row.label}</strong>
                <span class="tiny">{row.note}</span>
              </th>
              {comparePlaces.map((place) => (
                <td>{row.format(place)}</td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <section class="section" id="compare-explorer">
    <div class="section-head">
      <div>
        <h2>Explorer and shareable filters</h2>
        <p class="lede">
          The default compare set stays editorially useful, but this explorer lets readers move across the full
          authority dataset and keep the filter state in the URL.
        </p>
      </div>
      <span class="chip" data-compare-summary aria-live="polite">Showing 12 matching places</span>
    </div>
    <form class="filter-panel" data-compare-form>
      <div class="filter-grid">
        <label class="filter-field">
          <span class="tiny">Search place</span>
          <input type="search" name="compare_q" placeholder="Search area or region" />
        </label>
        <label class="filter-field">
          <span class="tiny">Region</span>
          <select name="compare_region">
            <option value="all">All regions</option>
            {compareExplorerRegions.map((region) => (
              <option value={region}>{region}</option>
            ))}
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Country</span>
          <select name="compare_country">
            <option value="all">All countries</option>
            {compareExplorerCountries.map((country) => (
              <option value={country}>{country}</option>
            ))}
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Sort by</span>
          <select name="compare_focus">
            <option value="supported">Supported asylum count</option>
            <option value="rate">Supported asylum rate</option>
            <option value="contingency">Contingency accommodation</option>
            <option value="humanitarian">Humanitarian pathway total</option>
            <option value="resettlement">Resettlement cumulative total</option>
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Local model</span>
          <select name="compare_model">
            <option value="all">All models</option>
            <option value="hotel-heavy">Hotel-heavy</option>
            <option value="dispersal-led">Dispersal-led</option>
            <option value="humanitarian-heavy">Humanitarian-heavy</option>
            <option value="balanced">Balanced</option>
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Show</span>
          <select name="compare_limit">
            <option value="12">12 places</option>
            <option value="24">24 places</option>
            <option value="48">48 places</option>
          </select>
        </label>
      </div>
      <div class="filter-actions">
        <button type="button" class="source-pill" data-compare-reset>Reset filters</button>
      </div>
    </form>
    <div class="story-grid explorer-grid" data-compare-results>
      {compareExplorerItems.map((item) => (
        <article
          class="story-card explorer-card"
          data-compare-item
          data-name={item.place.areaName}
          data-region={item.place.regionName}
          data-country={item.place.countryName}
          data-model={item.primaryModel}
          data-supported={item.place.supportedAsylum}
          data-rate={item.place.supportedAsylumRate ?? 0}
          data-contingency={item.place.contingencyAccommodation}
          data-humanitarian={item.humanitarianTotal}
          data-resettlement={item.place.resettlementCumulativeTotal}
        >
          <div class="chip-row">
            <span class="chip">{item.place.regionName}</span>
            <span class="chip teal">{item.place.countryName}</span>
            <span class={`chip ${item.primaryModel === "hotel-heavy" ? "accent" : item.primaryModel === "humanitarian-heavy" ? "teal" : ""}`}>
              {item.primaryModel}
            </span>
          </div>
          <h3>{item.place.areaName}</h3>
          <p class="lede">
            Supported asylum: {item.place.supportedAsylum.toLocaleString()} | rate {item.place.supportedAsylumRate ?? "n/a"} per 10,000
          </p>
          <div class="data-list">
            <div class="data-row">
              <span>Contingency accommodation</span>
              <span class="data-row-value">{item.place.contingencyAccommodation.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Humanitarian pathways</span>
              <span class="data-row-value">{item.humanitarianTotal.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Resettlement cumulative</span>
              <span class="data-row-value">{item.place.resettlementCumulativeTotal.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Three-pathway share of population</span>
              <span class="data-row-value">
                {item.place.shareOfPopulationPct !== null ? `${item.place.shareOfPopulationPct}%` : "n/a"}
              </span>
            </div>
          </div>
          <p class="tiny">
            {item.place.contingencyAccommodation > 0
              ? `${item.contingencySharePct}% of supported asylum is in contingency accommodation.`
              : "No contingency accommodation is recorded in the current local snapshot."}
          </p>
          <p class="tiny">
            <a class="source-pill" href={`/places/${item.place.areaCode}/`}>Open place page</a>
          </p>
        </article>
      ))}
    </div>
    <article class="editor-note" data-compare-empty hidden>
      <h3>No places match this filter set</h3>
      <p>Reset the filters or widen the region and model constraints to bring places back into scope.</p>
    </article>
  </section>

  <section class="split section">
    <div class="panel panel-pad">
      <h2>Supported asylum snapshot</h2>
      {comparePlaces.map((place) => (
        <div class="metric-bar">
          <div style="min-width: 10rem;">
            <strong>{place.areaName}</strong>
            <div class="tiny">{place.supportedAsylum.toLocaleString()}</div>
          </div>
          <div class="metric-track">
            <div class="metric-fill" style={`width: ${(place.supportedAsylum / maxSupported) * 100}%`}></div>
          </div>
        </div>
      ))}
    </div>

    <div class="panel panel-pad">
      <h2>All pathways load</h2>
      {comparePlaces.map((place) => (
        <div class="metric-bar">
          <div style="min-width: 10rem;">
            <strong>{place.areaName}</strong>
            <div class="tiny">{place.allThreePathwaysTotal.toLocaleString()}</div>
          </div>
          <div class="metric-track">
            <div class="metric-fill" style={`width: ${(place.allThreePathwaysTotal / maxAllPathways) * 100}%`}></div>
          </div>
        </div>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>What these four already prove</h2>
        <p class="lede">
          Even a small compare set exposes the difference between volume, rate, humanitarian pathway mix, and
          contingency-heavy local pressure.
        </p>
      </div>
    </div>
    <div class="story-grid">
      {compareEditorialCards.map((card) => (
        <article class="story-card">
          <h3>{card.title}</h3>
          <p class="lede">{card.body}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Top areas by route metric</h2>
        <p class="lede">
          The compare view should sit inside a wider map of local concentration, not replace it.
        </p>
      </div>
    </div>
    <div class="story-grid">
      {localRouteLatest.topAreasByMetric.map((metric) => (
        <article class="story-card">
          <h3>{metric.label}</h3>
          <div class="table-card">
            <table>
              <caption>Leading six areas for {metric.label.toLowerCase()} in the current local route dataset.</caption>
              <thead>
                <tr>
                  <th scope="col">Area</th>
                  <th scope="col">Value</th>
                </tr>
              </thead>
              <tbody>
                {metric.rows.slice(0, 6).map((row) => (
                  <tr>
                    <th scope="row">
                      <a href={`/places/${row.areaCode}/`}>{row.areaName}</a>
                    </th>
                    <td>{row.value.toLocaleString()}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </article>
      ))}
    </div>
  </section>

  <script>
    import { initCompareExplorer } from "../scripts/compare-explorer";

    initCompareExplorer();
  </script>
</BaseLayout>

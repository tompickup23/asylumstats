---
import BaseLayout from "../layouts/BaseLayout.astro";
import { loadHotelEntityLedger } from "../lib/hotel-data";

const hotelLedger = loadHotelEntityLedger();
const namedCurrent = hotelLedger.sites.filter((site) => site.status === "current");
const namedHistorical = hotelLedger.sites.filter((site) => site.status === "historical");
const parliamentaryReferences = hotelLedger.sites.filter(
  (site) => site.evidenceClass === "parliamentary_reference"
);
const unnamedOnlyAreas = hotelLedger.areas.filter((area) => area.visibilityClass === "all_unnamed");
const summaryCards = [
  {
    label: "Named current sites",
    value: hotelLedger.summary.currentNamedSites.toLocaleString(),
    detail: "Current named hotels in the public starter ledger."
  },
  {
    label: "Current sites with entity links",
    value: hotelLedger.summary.currentNamedSitesWithAnyEntityLinks.toLocaleString(),
    detail: "At least one owner, group, or operator link with documentary backing."
  },
  {
    label: "Current sites still unresolved",
    value: hotelLedger.summary.currentNamedSitesUnresolved.toLocaleString(),
    detail: "Publicly named current hotels where the ledger still lacks a publishable owner or operator match."
  },
  {
    label: "Areas with unnamed hotel counts",
    value: hotelLedger.summary.unnamedOnlyAreaCount.toLocaleString(),
    detail: "Places where public authorities acknowledge hotels but do not publish site names."
  }
];
const prioritySites = [...namedCurrent]
  .sort((a, b) => {
    const aScore = (a.entityCoverage === "unresolved" ? 4 : 0) + a.integritySignalCount;
    const bScore = (b.entityCoverage === "unresolved" ? 4 : 0) + b.integritySignalCount;
    return bScore - aScore;
  })
  .slice(0, 4);
const providerBreakdown = [...hotelLedger.primeProviderBreakdown].sort(
  (a, b) => b.currentNamedSiteCount - a.currentNamedSiteCount
);
const leadUnnamedArea = unnamedOnlyAreas[0];

function formatReportedPeople(value: number | null): string {
  return typeof value === "number" ? `${value.toLocaleString()} people reported` : "People total not published";
}
---

<BaseLayout
  title="Hotels | asylumstats"
  description="Named asylum hotel tracking, ownership and operator links, secrecy-gap evidence, and official hotel-use signals."
>
  <section class="page-top">
    <section class="page-head">
      <span class="kicker">Hotel tracker</span>
      <h1>Follow the hotels, then follow the owner and operator trail.</h1>
      <p>
        This page is about the asylum accommodation estate, not every migration route. The job is to make the visible
        estate, the hidden estate, and the unresolved ownership chain legible to the public.
      </p>
    </section>

    <aside class="page-rail">
      <article class="panel panel-pad">
        <span class="tiny">Visible estate snapshot</span>
        <p class="rail-copy">
          The current public estate is small, partial, and still strong enough to expose where the secrecy gap lives.
        </p>
        <div class="stat-strip">
          {summaryCards.map((card) => (
            <article class="stat-tile">
              <span class="tiny">{card.label}</span>
              <strong>{card.value}</strong>
              <p class="tiny">{card.detail}</p>
            </article>
          ))}
        </div>
      </article>

      {leadUnnamedArea && (
        <article class="panel panel-pad">
          <span class="tiny">Secrecy gap signal</span>
          <h2 class="rail-title">{leadUnnamedArea.areaName}</h2>
          <p class="rail-copy">
            {leadUnnamedArea.unnamedSiteCount} unnamed site{leadUnnamedArea.unnamedSiteCount > 1 ? "s" : ""} publicly
            acknowledged without a publishable hotel list.
          </p>
          <div class="chip-row">
            <span class="chip accent">{leadUnnamedArea.lastPublicDate}</span>
            <span class="chip">{formatReportedPeople(leadUnnamedArea.peopleHousedReported)}</span>
          </div>
        </article>
      )}
    </aside>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Official hotel pressure</h2>
        <p class="lede">
          Official hotel-use signals and public evidence tracking need to sit side by side. Otherwise the visible estate
          disappears behind national headlines.
        </p>
      </div>
    </div>
    <div class="kpi-grid">
      {hotelLedger.hotelFacts.map((fact) => (
        <article class="kpi-card">
          <div class="chip-row">
            <span class="chip accent">route specific</span>
          </div>
          <span class="tiny">{fact.label}</span>
          <strong>{fact.value}</strong>
          <small>{fact.period}</small>
          <p class="tiny">{fact.detail}</p>
          <p class="tiny">
            <a class="source-pill" href={fact.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Priority current sites</h2>
        <p class="lede">
          These current sites best show where naming, entity coverage, and integrity signals intersect.
        </p>
      </div>
      <span class="chip">{namedCurrent.length} current named sites in starter ledger</span>
    </div>
    <div class="feature-grid">
      {prioritySites.map((site) => (
        <article class="feature-card accent">
          <div class="chip-row">
            <span class="chip accent">{site.evidenceClass}</span>
            <span class="chip">{site.entityCoverage}</span>
            <span class="chip teal">{site.confidence}</span>
          </div>
          <h3>{site.siteName}</h3>
          <p class="lede">{site.areaName}</p>
          <div class="data-list">
            <div class="data-row">
              <span>Owner</span>
              <span class="data-row-value">{site.ownerName ?? "Not yet resolved"}</span>
            </div>
            <div class="data-row">
              <span>Operator</span>
              <span class="data-row-value">{site.operatorName ?? "Not yet resolved"}</span>
            </div>
            <div class="data-row">
              <span>Prime provider</span>
              <span class="data-row-value">{site.primeProvider?.provider ?? "Not yet attached"}</span>
            </div>
            <div class="data-row">
              <span>Integrity signals</span>
              <span class="data-row-value">{site.integritySignalCount.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>People housed</span>
              <span class="data-row-value">{formatReportedPeople(site.peopleHousedReported)}</span>
            </div>
          </div>
          {site.integritySignals[0]?.headline && (
            <article class="signal-card accent">
              <span class="tiny">{site.integritySignals[0].severity}</span>
              <h3>{site.integritySignals[0].headline}</h3>
              {site.integritySignals[0].detail && <p class="tiny">{site.integritySignals[0].detail}</p>}
            </article>
          )}
          <p class="tiny">
            <a class="source-pill" href={site.sourceUrl}>Site evidence</a>
            {site.primeProvider && <a class="source-pill" href={site.primeProvider.sourceUrl}>Provider region</a>}
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section">
    <div class="panel panel-pad">
      <h2>Named current sites with entity status</h2>
      <div class="story-grid">
        {namedCurrent.map((site) => (
          <article class="story-card">
            <div class="chip-row">
              <span class="chip accent">{site.evidenceClass}</span>
              <span class="chip">{site.entityCoverage}</span>
              <span class="chip teal">{site.confidence}</span>
            </div>
            <h3>{site.siteName}</h3>
            <p class="lede">{site.areaName}</p>
            <p class="tiny">
              Owner: {site.ownerName ?? "Not yet resolved"}
            </p>
            <p class="tiny">
              Operator: {site.operatorName ?? "Not yet resolved"}
            </p>
            <p class="tiny">
              Prime provider: {site.primeProvider?.provider ?? "Current regional mapping not attached"}
            </p>
            <p class="tiny">
              Integrity signals: {site.integritySignalCount}
            </p>
            <p class="tiny">Last public evidence: {site.lastPublicDate}</p>
            <p class="tiny">
              <a class="source-pill" href={site.sourceUrl}>Site evidence</a>
              {site.primeProvider && <a class="source-pill" href={site.primeProvider.sourceUrl}>Provider region</a>}
            </p>
          </article>
        ))}
      </div>
    </div>

    <div class="panel panel-pad">
      <h2>Unnamed areas that prove the secrecy gap</h2>
      <div class="story-grid">
        {unnamedOnlyAreas.map((area) => (
          <article class="story-card">
            <div class="chip-row">
              <span class="chip accent">
                {area.unnamedSiteCount} unnamed site{area.unnamedSiteCount > 1 ? "s" : ""}
              </span>
              {area.peopleHousedReported !== null && <span class="chip">{area.peopleHousedReported} people reported</span>}
            </div>
            <h3>{area.areaName}</h3>
            <p class="lede">{area.notes}</p>
            <p class="tiny">Last public reference: {area.lastPublicDate}</p>
            <p class="tiny">
              <a class="source-pill" href={area.sourceUrl}>Source</a>
            </p>
          </article>
        ))}
      </div>
    </div>
  </section>

  <section class="split section">
    <div class="panel panel-pad">
      <h2>Prime provider exposure in the visible estate</h2>
      <div class="signal-list">
        {providerBreakdown.map((provider) => (
          <article class="signal-card">
            <div class="chip-row">
              <span class="chip accent">
                {provider.currentNamedSiteCount} named current site{provider.currentNamedSiteCount > 1 ? "s" : ""}
              </span>
            </div>
            <h3>{provider.provider}</h3>
            <p class="tiny">{provider.regions.join(", ")}</p>
            <p class="tiny">
              <a class="source-pill" href={provider.sourceUrl}>Contract source</a>
            </p>
          </article>
        ))}
      </div>
    </div>

    <div class="panel panel-pad">
      <h2>How to read the current evidence</h2>
      <div class="signal-list">
        <article class="signal-card accent">
          <span class="tiny">Coverage rule</span>
          <h3>Named does not mean resolved</h3>
          <p class="tiny">
            Public naming is only the first layer. This ledger attaches at least one owner, group, or operator link to{" "}
            {hotelLedger.summary.currentNamedSitesWithAnyEntityLinks} of the{" "}
            {hotelLedger.summary.currentNamedSites} current named sites.
          </p>
        </article>
        <article class="signal-card">
          <span class="tiny">Role separation</span>
          <h3>Owner and operator are not the same thing</h3>
          <p class="tiny">
            The site keeps group owner, site owner, operator brand, and regional asylum provider separate so the public
            can see where the chain breaks.
          </p>
        </article>
        <article class="signal-card">
          <span class="tiny">Publishable finding</span>
          <h3>Visibility gaps are evidence</h3>
          <p class="tiny">
            {hotelLedger.summary.unnamedOnlyAreaCount} areas in the live starter ledger acknowledge hotel use publicly
            without publishing a full site list.
          </p>
        </article>
      </div>
    </div>
  </section>

  <section class="section">
    <h2>Full starter ledger</h2>
    <div class="table-card">
      <table>
        <thead>
          <tr>
            <th>Site</th>
            <th>Status</th>
            <th>Area</th>
            <th>Coverage</th>
            <th>Linked entities</th>
            <th>Signals</th>
          </tr>
        </thead>
        <tbody>
          {[...namedCurrent, ...namedHistorical, ...parliamentaryReferences].map((site) => (
            <tr>
              <td>
                <strong>{site.siteName}</strong>
                <div class="tiny">
                  <a class="source-pill" href={site.sourceUrl}>Site evidence</a>
                </div>
              </td>
              <td>{site.status}</td>
              <td>
                {site.areaName}
                <div class="tiny">{site.regionName}</div>
              </td>
              <td>
                <div class="chip-row">
                  <span class="chip">{site.entityCoverage}</span>
                  <span class="chip">{site.evidenceClass}</span>
                </div>
                {site.primeProvider && <div class="tiny">Prime: {site.primeProvider.provider}</div>}
              </td>
              <td>
                {site.entityLinks.length > 0 ? (
                  site.entityLinks.map((link) => (
                    <div class="tiny" style="margin-bottom: 0.5rem;">
                      <strong>{link.entityName}</strong> | {link.linkRole} | {link.confidence}
                      {link.companyNumber && <div>{link.companyNumber}</div>}
                    </div>
                  ))
                ) : (
                  <span class="tiny">No publishable owner or operator link yet.</span>
                )}
              </td>
              <td>
                {site.integritySignals.length > 0 ? (
                  site.integritySignals.map((signal) => (
                    <div class="tiny" style="margin-bottom: 0.5rem;">
                      <strong>{signal.severity}</strong> | {signal.headline}
                    </div>
                  ))
                ) : (
                  <span class="tiny">No live integrity signal in starter ledger.</span>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Current limitations</h2>
        <p class="lede">
          The estate is still only partly visible. These are the main reasons the hotel picture remains incomplete.
        </p>
      </div>
    </div>
    <div class="story-grid">
      {hotelLedger.limitations.map((item) => (
        <article class="story-card">
          <p class="lede">{item}</p>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>

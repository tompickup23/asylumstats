---
import BaseLayout from "../layouts/BaseLayout.astro";
import RegionTileMap from "../components/RegionTileMap.astro";
import { loadHotelEntityLedger } from "../lib/hotel-data";
import {
  getHotelCoverageSummary,
  getHotelRegionVisibilitySummaries,
  getHotelVisibilityAreas,
  getHotelWatchlist
} from "../lib/hotel-analytics";

const hotelLedger = loadHotelEntityLedger();
const namedCurrent = hotelLedger.sites.filter((site) => site.status === "current");
const namedHistorical = hotelLedger.sites.filter((site) => site.status === "historical");
const parliamentaryReferences = hotelLedger.sites.filter(
  (site) => site.evidenceClass === "parliamentary_reference"
);
const unnamedOnlyAreas = hotelLedger.areas.filter((area) => area.visibilityClass === "all_unnamed");
const summaryCards = [
  {
    label: "Named current sites",
    value: hotelLedger.summary.currentNamedSites.toLocaleString(),
    detail: "Current named hotels in the public starter ledger."
  },
  {
    label: "Current sites with entity links",
    value: hotelLedger.summary.currentNamedSitesWithAnyEntityLinks.toLocaleString(),
    detail: "At least one owner, group, or operator link with documentary backing."
  },
  {
    label: "Current sites still unresolved",
    value: hotelLedger.summary.currentNamedSitesUnresolved.toLocaleString(),
    detail: "Publicly named current hotels where the ledger still lacks a publishable owner or operator match."
  },
  {
    label: "Areas with unnamed hotel counts",
    value: hotelLedger.summary.unnamedOnlyAreaCount.toLocaleString(),
    detail: "Places where public authorities acknowledge hotels but do not publish site names."
  }
];
const watchlist = getHotelWatchlist(namedCurrent, 4);
const coverageSummary = getHotelCoverageSummary(namedCurrent);
const providerBreakdown = [...hotelLedger.primeProviderBreakdown].sort(
  (a, b) => b.currentNamedSiteCount - a.currentNamedSiteCount
);
const regionVisibility = getHotelRegionVisibilitySummaries(hotelLedger);
const visibilityAreas = getHotelVisibilityAreas(hotelLedger.areas);
const leadUnnamedArea = unnamedOnlyAreas[0];
const namedRegionLeader = regionVisibility[0];
const secrecyRegionLeader = [...regionVisibility].sort((a, b) => b.unnamedSiteCount - a.unnamedSiteCount)[0];
const hotelReadoutCards = [
  {
    title: "Named does not mean resolved",
    body: `${coverageSummary.partial} of the ${namedCurrent.length} current named sites have only partial owner or operator coverage, and ${coverageSummary.unresolved} remain unresolved. Public naming is only the first step in the chain.`
  },
  secrecyRegionLeader
    ? {
        title: "The secrecy gap is regional, not abstract",
        body: `${secrecyRegionLeader.regionName} currently leads the live ledger on unnamed publicly acknowledged sites, showing how councils can confirm hotel use without publishing the full estate.`
      }
    : null,
  namedRegionLeader
    ? {
        title: "Visible concentration is already uneven",
        body: `${namedRegionLeader.regionName} currently has the largest count of named current sites in the starter ledger, which means public hotel scrutiny is already clustering geographically.`
      }
    : null
].filter((card): card is { title: string; body: string } => card !== null);

function formatReportedPeople(value: number | null): string {
  return typeof value === "number" ? `${value.toLocaleString()} people reported` : "People total not published";
}
---

<BaseLayout
  title="Hotels | asylumstats"
  description="Named asylum hotel tracking, ownership and operator links, secrecy-gap evidence, and official hotel-use signals."
>
  <section class="page-top">
    <section class="page-head">
      <span class="kicker">Hotel tracker</span>
      <h1>Follow the hotel, then follow the chain that sits behind it.</h1>
      <p>
        This page is about the asylum accommodation estate, not every migration route. The job is to make the visible
        estate, the hidden estate, and the unresolved ownership chain legible on one public surface.
      </p>
    </section>

    <aside class="page-rail">
      <article class="panel panel-pad">
        <span class="tiny">Visible estate snapshot</span>
        <p class="rail-copy">
          The current public estate is small, partial, and still strong enough to expose where the secrecy gap lives.
        </p>
        <div class="stat-strip">
          {summaryCards.map((card) => (
            <article class="stat-tile">
              <span class="tiny">{card.label}</span>
              <strong>{card.value}</strong>
              <p class="tiny">{card.detail}</p>
            </article>
          ))}
        </div>
      </article>

      {leadUnnamedArea && (
        <article class="panel panel-pad">
          <span class="tiny">Secrecy gap signal</span>
          <h2 class="rail-title">{leadUnnamedArea.areaName}</h2>
          <p class="rail-copy">
            {leadUnnamedArea.unnamedSiteCount} unnamed site{leadUnnamedArea.unnamedSiteCount > 1 ? "s" : ""} publicly
            acknowledged without a publishable hotel list.
          </p>
          <div class="chip-row">
            <span class="chip accent">{leadUnnamedArea.lastPublicDate}</span>
            <span class="chip">{formatReportedPeople(leadUnnamedArea.peopleHousedReported)}</span>
          </div>
        </article>
      )}
    </aside>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Official hotel pressure</h2>
        <p class="lede">
          Official hotel-use signals and public evidence tracking need to sit side by side. Otherwise the visible estate
          disappears behind national headlines.
        </p>
      </div>
    </div>
    <div class="kpi-grid">
      {hotelLedger.hotelFacts.map((fact) => (
        <article class="kpi-card">
          <div class="chip-row">
            <span class="chip accent">route specific</span>
          </div>
          <span class="tiny">{fact.label}</span>
          <strong>{fact.value}</strong>
          <small>{fact.period}</small>
          <p class="tiny">{fact.detail}</p>
          <p class="tiny">
            <a class="source-pill" href={fact.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Regional visibility pattern</h2>
        <p class="lede">
          The hotel ledger is still partial, but it is already regional enough to show where named sites cluster and
          where unnamed public acknowledgements are doing the hiding.
        </p>
      </div>
      <span class="chip">{regionVisibility.length} regions with live hotel evidence</span>
    </div>
    <div class="viz-grid">
      <RegionTileMap
        items={regionVisibility.map((region) => ({ regionName: region.regionName, value: region.currentNamedSiteCount }))}
        title="Current named hotel sites by region"
        description={
          namedRegionLeader
            ? `${namedRegionLeader.regionName} currently leads the starter ledger on named current sites.`
            : "Named current site coverage is still sparse."
        }
        valueLabel="named current sites"
      />
      <RegionTileMap
        items={regionVisibility.map((region) => ({ regionName: region.regionName, value: region.unnamedSiteCount }))}
        title="Unnamed publicly acknowledged sites by region"
        description={
          secrecyRegionLeader
            ? `${secrecyRegionLeader.regionName} currently leads the live ledger on unnamed site acknowledgements.`
            : "Unnamed site acknowledgements are not yet present in the live ledger."
        }
        valueLabel="unnamed sites"
        tone="warm"
      />
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Unresolved chain watchlist</h2>
        <p class="lede">
          These current sites best show where naming, entity coverage, provider mapping, and integrity signals still
          need to be held together.
        </p>
      </div>
      <span class="chip">{watchlist.length} sites on the current watchlist</span>
    </div>
    <div class="feature-grid">
      {watchlist.map((site) => (
        <article class="feature-card accent">
          <div class="chip-row">
            <span class="chip accent">{site.entityCoverage}</span>
            <span class="chip">{site.evidenceClass}</span>
            <span class="chip teal">{site.confidence}</span>
          </div>
          <h3>{site.siteName}</h3>
          <p class="lede">
            {site.areaName}, {site.regionName}
          </p>
          <div class="data-list">
            <div class="data-row">
              <span>Owner</span>
              <span class="data-row-value">{site.ownerName ?? "Not yet resolved"}</span>
            </div>
            <div class="data-row">
              <span>Operator</span>
              <span class="data-row-value">{site.operatorName ?? "Not yet resolved"}</span>
            </div>
            <div class="data-row">
              <span>Prime provider</span>
              <span class="data-row-value">{site.primeProvider?.provider ?? "Not yet attached"}</span>
            </div>
            <div class="data-row">
              <span>Integrity signals</span>
              <span class="data-row-value">{site.integritySignalCount.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>People housed</span>
              <span class="data-row-value">{formatReportedPeople(site.peopleHousedReported)}</span>
            </div>
          </div>
          {site.integritySignals[0]?.headline && (
            <article class="signal-card accent">
              <span class="tiny">{site.integritySignals[0].severity}</span>
              <h3>{site.integritySignals[0].headline}</h3>
              {site.integritySignals[0].detail && <p class="tiny">{site.integritySignals[0].detail}</p>}
            </article>
          )}
          <p class="tiny">
            <a class="source-pill" href={site.sourceUrl}>Site evidence</a>
            {site.primeProvider && <a class="source-pill" href={site.primeProvider.sourceUrl}>Provider region</a>}
            {site.areaCode && <a class="source-pill" href={`/places/${site.areaCode}/`}>Open place page</a>}
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section">
    <div class="panel panel-pad">
      <h2>Named current sites with entity status</h2>
      <div class="story-grid">
        {namedCurrent.map((site) => (
          <article class="story-card">
            <div class="chip-row">
              <span class="chip accent">{site.evidenceClass}</span>
              <span class="chip">{site.entityCoverage}</span>
              <span class="chip teal">{site.confidence}</span>
            </div>
            <h3>{site.siteName}</h3>
            <p class="lede">{site.areaName}</p>
            <p class="tiny">Owner: {site.ownerName ?? "Not yet resolved"}</p>
            <p class="tiny">Operator: {site.operatorName ?? "Not yet resolved"}</p>
            <p class="tiny">Prime provider: {site.primeProvider?.provider ?? "Current regional mapping not attached"}</p>
            <p class="tiny">Integrity signals: {site.integritySignalCount}</p>
            <p class="tiny">Last public evidence: {site.lastPublicDate}</p>
            <p class="tiny">
              <a class="source-pill" href={site.sourceUrl}>Site evidence</a>
              {site.primeProvider && <a class="source-pill" href={site.primeProvider.sourceUrl}>Provider region</a>}
              {site.areaCode && <a class="source-pill" href={`/places/${site.areaCode}/`}>Open place page</a>}
            </p>
          </article>
        ))}
      </div>
    </div>

    <div class="panel panel-pad">
      <h2>Unnamed areas that prove the secrecy gap</h2>
      <div class="story-grid">
        {unnamedOnlyAreas.map((area) => (
          <article class="story-card">
            <div class="chip-row">
              <span class="chip accent">
                {area.unnamedSiteCount} unnamed site{area.unnamedSiteCount > 1 ? "s" : ""}
              </span>
              {area.peopleHousedReported !== null && <span class="chip">{area.peopleHousedReported} people reported</span>}
            </div>
            <h3>{area.areaName}</h3>
            <p class="lede">{area.notes}</p>
            <p class="tiny">Last public reference: {area.lastPublicDate}</p>
            <p class="tiny">
              <a class="source-pill" href={area.sourceUrl}>Source</a>
              {area.areaCode && <a class="source-pill" href={`/places/${area.areaCode}/`}>Open place page</a>}
            </p>
          </article>
        ))}
      </div>
    </div>
  </section>

  <section class="split section">
    <div class="panel panel-pad">
      <h2>Prime provider exposure in the visible estate</h2>
      <div class="signal-list">
        {providerBreakdown.map((provider) => (
          <article class="signal-card">
            <div class="chip-row">
              <span class="chip accent">
                {provider.currentNamedSiteCount} named current site{provider.currentNamedSiteCount > 1 ? "s" : ""}
              </span>
            </div>
            <h3>{provider.provider}</h3>
            <p class="tiny">{provider.regions.join(", ")}</p>
            <p class="tiny">
              <a class="source-pill" href={provider.sourceUrl}>Contract source</a>
            </p>
          </article>
        ))}
      </div>
    </div>

    <div class="panel panel-pad">
      <h2>What the visible estate already proves</h2>
      <div class="signal-list">
        {hotelReadoutCards.map((card, index) => (
          <article class={`signal-card${index === 0 ? " accent" : ""}`}>
            <h3>{card.title}</h3>
            <p class="tiny">{card.body}</p>
          </article>
        ))}
      </div>
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Area visibility ledger</h2>
        <p class="lede">
          This table keeps named sites, unnamed acknowledgements, and the last public reference on one line for each
          area in the live hotel starter ledger.
        </p>
      </div>
    </div>
    <div class="table-card">
      <table>
        <caption>Area-level visibility ledger showing named current sites, historical references, unnamed public acknowledgements, and latest evidence dates.</caption>
        <thead>
          <tr>
            <th scope="col">Area</th>
            <th scope="col">Region</th>
            <th scope="col">Visible named sites</th>
            <th scope="col">Unnamed acknowledged sites</th>
            <th scope="col">Last public date</th>
            <th scope="col">Evidence</th>
          </tr>
        </thead>
        <tbody>
          {visibilityAreas.map((area) => (
            <tr>
              <th scope="row">
                <strong>{area.areaName}</strong>
                {area.areaCode && (
                  <div class="tiny">
                    <a class="source-pill" href={`/places/${area.areaCode}/`}>Open place page</a>
                  </div>
                )}
              </th>
              <td>{area.regionName}</td>
              <td>
                <div class="tiny">Current named: {area.currentNamedSiteCount}</div>
                <div class="tiny">Historical named: {area.historicalNamedSiteCount}</div>
                <div class="tiny">Parliamentary refs: {area.parliamentaryReferenceCount}</div>
              </td>
              <td>
                <div class="tiny">{area.unnamedSiteCount} site{area.unnamedSiteCount === 1 ? "" : "s"}</div>
                <div class="tiny">{formatReportedPeople(area.peopleHousedReported)}</div>
              </td>
              <td>{area.lastPublicDate}</td>
              <td>
                <a class="source-pill" href={area.sourceUrl}>Source</a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <section class="section">
    <h2>Full starter ledger</h2>
    <div class="table-card">
      <table>
        <caption>Named current, historical, and parliamentary-reference hotel sites with coverage status, linked entities, and integrity signals.</caption>
        <thead>
          <tr>
            <th scope="col">Site</th>
            <th scope="col">Status</th>
            <th scope="col">Area</th>
            <th scope="col">Coverage</th>
            <th scope="col">Linked entities</th>
            <th scope="col">Signals</th>
          </tr>
        </thead>
        <tbody>
          {[...namedCurrent, ...namedHistorical, ...parliamentaryReferences].map((site) => (
            <tr>
              <th scope="row">
                <strong>{site.siteName}</strong>
                <div class="tiny">
                  <a class="source-pill" href={site.sourceUrl}>Site evidence</a>
                </div>
              </th>
              <td>{site.status}</td>
              <td>
                {site.areaName}
                <div class="tiny">{site.regionName}</div>
                {site.areaCode && (
                  <div class="tiny">
                    <a href={`/places/${site.areaCode}/`}>Place page</a>
                  </div>
                )}
              </td>
              <td>
                <div class="chip-row">
                  <span class="chip">{site.entityCoverage}</span>
                  <span class="chip">{site.evidenceClass}</span>
                </div>
                {site.primeProvider && <div class="tiny">Prime: {site.primeProvider.provider}</div>}
              </td>
              <td>
                {site.entityLinks.length > 0 ? (
                  site.entityLinks.map((link) => (
                    <div class="tiny" style="margin-bottom: 0.5rem;">
                      <strong>{link.entityName}</strong> | {link.linkRole} | {link.confidence}
                      {link.companyNumber && <div>{link.companyNumber}</div>}
                    </div>
                  ))
                ) : (
                  <span class="tiny">No publishable owner or operator link yet.</span>
                )}
              </td>
              <td>
                {site.integritySignals.length > 0 ? (
                  site.integritySignals.map((signal) => (
                    <div class="tiny" style="margin-bottom: 0.5rem;">
                      <strong>{signal.severity}</strong> | {signal.headline}
                    </div>
                  ))
                ) : (
                  <span class="tiny">No live integrity signal in starter ledger.</span>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Current limitations</h2>
        <p class="lede">
          The estate is still only partly visible. These are the main reasons the hotel picture remains incomplete.
        </p>
      </div>
    </div>
    <div class="story-grid">
      {hotelLedger.limitations.map((item) => (
        <article class="story-card">
          <p class="lede">{item}</p>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>

---
import BaseLayout from "../layouts/BaseLayout.astro";
import InvestigationTrail from "../components/InvestigationTrail.astro";
import PageContents from "../components/PageContents.astro";
import PathwayMixCard from "../components/PathwayMixCard.astro";
import RegionTileMap from "../components/RegionTileMap.astro";
import asylumFinance from "../data/live/asylum-finance.json";
import followMoney from "../data/live/follow-money.json";
import { loadHotelEntityLedger } from "../lib/hotel-data";
import { getSpendingLinkedSiteTrails } from "../lib/investigations";
import { loadMoneyLedger } from "../lib/money-data";
import {
  getMoneyBuyerSummaries,
  getMoneyLinkedRegionSummaries,
  getMoneyRecordTypeSummaries,
  getMoneyRouteSummaries
} from "../lib/money-analytics";
import { loadLocalRouteLatest } from "../lib/route-data";

const hotelLedger = loadHotelEntityLedger();
const moneyLedger = loadMoneyLedger();
const localRouteLatest = loadLocalRouteLatest();
const topSuppliers = moneyLedger.supplierProfiles.slice(0, 8);
type MoneyRecordWithValue = (typeof moneyLedger.records)[number] & { valueGbp: number };
const highValueRecords = moneyLedger.records
  .filter((record): record is MoneyRecordWithValue => typeof record.valueGbp === "number")
  .sort((a, b) => b.valueGbp - a.valueGbp)
  .slice(0, 3);
const supplierWatchlist = [...moneyLedger.supplierProfiles]
  .sort(
    (a, b) =>
      (b.publicContractValueGbp ?? 0) - (a.publicContractValueGbp ?? 0) ||
      b.publicContractCount - a.publicContractCount ||
      b.siteCount - a.siteCount
  )
  .slice(0, 4);
const routeSummaries = getMoneyRouteSummaries(moneyLedger.records);
const recordTypeSummaries = getMoneyRecordTypeSummaries(moneyLedger.records);
const buyerSummaries = getMoneyBuyerSummaries(moneyLedger.records);
const linkedRegionSummaries = getMoneyLinkedRegionSummaries(moneyLedger.records);
const topBuyers = buyerSummaries.slice(0, 3);
const leadRoute = routeSummaries[0];
const leadRecordType = recordTypeSummaries[0];
const leadBuyer = buyerSummaries[0];
const leadMoneyRegion = linkedRegionSummaries[0];
const primaryLead = moneyLedger.investigativeLeads[0];
const investigativeLeadHighlights = moneyLedger.investigativeLeads.slice(1, 4);
const spendingSiteTrails = getSpendingLinkedSiteTrails(localRouteLatest.areas, hotelLedger, moneyLedger, 4);
const segmentTones = ["accent", "teal", "warm", "soft"] as const;
const routeValueLabel =
  moneyLedger.summary.rowsWithDisclosedValue > 0
    ? `${moneyLedger.summary.rowsWithDisclosedValue} rows with published values`
    : "No rows with published values";

const recordTypeLabels: Record<string, string> = {
  prime_contract_scope: "Prime contract scope",
  funding_instruction: "Funding instruction",
  scrutiny_estimate: "Scrutiny estimate",
  cost_indicator: "Cost indicator",
  local_response_contract: "Local response contract",
  other: "Other"
};

function formatMoney(value: number | null | undefined): string {
  if (typeof value !== "number") {
    return "Not disclosed / not normalized";
  }

  return new Intl.NumberFormat("en-GB", {
    style: "currency",
    currency: "GBP",
    maximumFractionDigits: value >= 1000 ? 0 : 2
  }).format(value);
}

function formatRouteFamily(routeFamily: string | null | undefined): string {
  switch (routeFamily) {
    case "asylum_support":
      return "Asylum support";
    case "homes_for_ukraine":
      return "Homes for Ukraine";
    case "uk_resettlement_scheme":
      return "UK Resettlement Scheme";
    case "afghan_resettlement_programme":
      return "Afghan Resettlement Programme";
    case "not_route_specific":
      return "Not route-specific";
    default:
      return routeFamily ?? "Not route-specific";
  }
}

function buildPresetHref(pathname: string, params: Record<string, string>, hash: string): string {
  return `${pathname}?${new URLSearchParams(params).toString()}#${hash}`;
}

const moneyRouteOptions = [...new Set(moneyLedger.records.map((record) => record.routeFamily ?? "not_route_specific"))].sort(
  (left, right) => formatRouteFamily(left).localeCompare(formatRouteFamily(right))
);
const moneyTypeOptions = [...new Set(moneyLedger.records.map((record) => record.recordType))].sort((left, right) =>
  (recordTypeLabels[left] ?? left).localeCompare(recordTypeLabels[right] ?? right)
);
const moneyBuyerOptions = [...new Set(moneyLedger.records.map((record) => record.buyerName))].sort((left, right) =>
  left.localeCompare(right)
);
const moneyScopeOptions = [...new Set(moneyLedger.records.map((record) => record.scopeClass))].sort((left, right) =>
  left.localeCompare(right)
);

const spendingReadoutCards = [
  leadRoute
    ? {
        title: "Asylum support still dominates the money ledger",
        body: `${formatRouteFamily(leadRoute.routeFamily)} accounts for ${leadRoute.recordCount} of the ${moneyLedger.summary.totalRecords} public rows now in scope, with ${leadRoute.linkedSiteCount} named sites already tied into the money layer.`
      }
    : null,
  leadRecordType
    ? {
        title: "Record type still matters more than one headline spend total",
        body: `${recordTypeLabels[leadRecordType.recordType] ?? leadRecordType.recordType} is the largest ledger class by row count. The page keeps row types separate because tariffs, contract scope, and scrutiny estimates are not comparable as one fake total.`
      }
    : null,
  leadBuyer
    ? {
        title: "Buyer control is concentrated",
        body: `${leadBuyer.buyerName} currently appears on ${leadBuyer.recordCount} public rows across ${leadBuyer.routeFamilyCount} route families, which is why buyer-level accountability belongs alongside supplier exposure.`
      }
    : null,
  leadMoneyRegion
    ? {
        title: "Site-linked money rows are already geographically concentrated",
        body: `${leadMoneyRegion.regionName} currently leads the starter money ledger on linked named sites, showing where contract responsibility and the visible estate already overlap in public evidence.`
      }
    : null
].filter((card): card is { title: string; body: string } => card !== null);
const spendingPresetViews = [
  {
    title: "Asylum support rows with published values",
    body: "Focus on asylum-support money rows that already disclose normalized GBP values and sort them by size.",
    href: buildPresetHref(
      "/spending/",
      {
        money_route: "asylum_support",
        money_value: "with_value",
        money_sort: "value"
      },
      "money-explorer"
    ),
    cta: "Open asylum support spend"
  },
  {
    title: "Homes for Ukraine funding rows",
    body: "Jump straight into the Homes for Ukraine money layer and keep the funding rows grouped together.",
    href: buildPresetHref(
      "/spending/",
      {
        money_route: "homes_for_ukraine",
        money_type: "funding_instruction",
        money_sort: "value"
      },
      "money-explorer"
    ),
    cta: "Open Ukraine funding"
  },
  {
    title: "Scrutiny rows without published values",
    body: "Surface scrutiny estimates and non-disclosed rows, where accountability often depends on evidence links rather than a published price tag.",
    href: buildPresetHref(
      "/spending/",
      {
        money_type: "scrutiny_estimate",
        money_value: "without_value",
        money_sort: "linked_sites"
      },
      "money-explorer"
    ),
    cta: "Open scrutiny view"
  },
  {
    title: "Afghan programme money surface",
    body: "Keep the Afghan programme rows together and rank the visible items by published value.",
    href: buildPresetHref(
      "/spending/",
      {
        money_route: "afghan_resettlement_programme",
        money_sort: "value"
      },
      "money-explorer"
    ),
    cta: "Open Afghan view"
  }
];
const spendingSections = [
  { id: "money-findings", label: "Findings" },
  { id: "where-values", label: "Big rows" },
  { id: "supplier-watchlist", label: "Watchlist" },
  ...(spendingSiteTrails.length > 0 ? [{ id: "money-site-trails", label: "Site trails" }] : []),
  { id: "money-composition", label: "Composition" },
  { id: "money-readout", label: "Readout" },
  { id: "money-presets", label: "Presets" },
  { id: "money-explorer", label: "Explorer" },
  { id: "money-ledger", label: "Ledger" },
  { id: "supplier-profiles", label: "Profiles" },
  { id: "investigative-leads", label: "Leads" }
];
---

<BaseLayout
  title="Spending | asylumstats"
  description="Public money ledger for asylum accommodation, contract scope, official tariff rows, hotel costs, and supplier exposure."
>
  <section class="page-top">
    <section class="page-head">
      <span class="kicker">Spending and contracts</span>
      <h1>Follow the migrants, follow the money, and keep the route labels honest.</h1>
      <p>
        The public money layer now has a real starter ledger behind it. It mixes prime contract scope, official funding
        instructions, and scrutiny cost rows so the public can see where money is documented, where it is estimated,
        and where the supplier chain still disappears into opacity.
      </p>
    </section>

    <aside class="page-rail">
      <article class="panel panel-pad">
        <span class="tiny">Money layer snapshot</span>
        <p class="rail-copy">
          The goal is not one spend total. It is to separate disclosed values, contractual control, and scrutiny
          evidence clearly enough that the missing pieces stand out.
        </p>
        <div class="stat-strip">
          <article class="stat-tile">
            <span class="tiny">Ledger rows</span>
            <strong>{moneyLedger.summary.totalRecords.toLocaleString()}</strong>
            <p class="tiny">Contracts, tariffs, and scrutiny rows.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Rows with published values</span>
            <strong>{moneyLedger.summary.rowsWithDisclosedValue.toLocaleString()}</strong>
            <p class="tiny">Explicit GBP values only.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Route families covered</span>
            <strong>{moneyLedger.summary.routeFamiliesCovered.toLocaleString()}</strong>
            <p class="tiny">Distinct route families in the starter ledger.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Linked named sites</span>
            <strong>{moneyLedger.summary.linkedNamedSites.toLocaleString()}</strong>
            <p class="tiny">Visible hotels tied to money rows.</p>
          </article>
        </div>
      </article>

      {primaryLead && (
        <article class="panel panel-pad">
          <span class="tiny">Priority lead</span>
          <h2 class="rail-title">{primaryLead.title}</h2>
          <p class="rail-copy">{primaryLead.detail}</p>
          <div class="chip-row">
            <span class={`chip ${primaryLead.severity === "warning" ? "accent" : ""}`}>{primaryLead.severity}</span>
            <a class="source-pill" href={primaryLead.sourceUrl}>Source</a>
          </div>
        </article>
      )}
    </aside>
  </section>

  <PageContents title="Jump to evidence" sections={spendingSections} variant="priority" />

  <section id="money-findings" class="section section-anchor priority-section">
    <div class="section-head">
      <div>
        <h2>What matters first</h2>
        <p class="lede">
          {leadRoute && leadBuyer
            ? `${formatRouteFamily(leadRoute.routeFamily)} already accounts for ${leadRoute.recordCount} of the ${moneyLedger.summary.totalRecords} public money rows in scope, and ${leadBuyer.buyerName} appears on ${leadBuyer.recordCount} of them.`
            : "The public money layer already exposes concentration before the full ledger is complete."}
        </p>
      </div>
      {primaryLead && <span class={`chip ${primaryLead.severity === "warning" ? "accent" : ""}`}>{primaryLead.severity}</span>}
    </div>
    {primaryLead && (
      <article class="editor-note">
        <h3>{primaryLead.title}</h3>
        <p>{primaryLead.detail}</p>
        <p class="tiny">
          <a class="source-pill" href={primaryLead.sourceUrl}>Source</a>
        </p>
      </article>
    )}
    <div class="story-grid">
      {spendingReadoutCards.map((card) => (
        <article class="story-card">
          <h3>{card.title}</h3>
          <p class="lede">{card.body}</p>
        </article>
      ))}
    </div>
    <div class="story-grid">
      {investigativeLeadHighlights.map((lead) => (
        <article class="story-card">
          <div class="chip-row">
            <span class={`chip ${lead.severity === "warning" ? "accent" : ""}`}>{lead.severity}</span>
          </div>
          <h3>{lead.title}</h3>
          <p class="lede">{lead.detail}</p>
          <p class="tiny">
            <a class="source-pill" href={lead.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section id="where-values" class="section section-anchor priority-section">
    <div class="section-head">
      <div>
        <h2>Big disclosed rows already visible</h2>
        <p class="lede">
          {highValueRecords[0]
            ? `${highValueRecords[0].title} is already visible at ${formatMoney(highValueRecords[0].valueGbp)}. The problem is not the absence of public numbers; it is keeping unlike rows separate and legible.`
            : "The starter ledger already contains large public figures. They need clear route labels and context, not flattening into one misleading spend total."}
        </p>
      </div>
      <span class="chip">{moneyLedger.summary.uniqueSuppliers.toLocaleString()} suppliers or public bodies tracked</span>
    </div>
    <div class="feature-grid">
      {highValueRecords.map((record) => (
        <article class="feature-card accent">
          <div class="chip-row">
            <span class="chip accent">{recordTypeLabels[record.recordType] ?? record.recordType}</span>
            {record.routeFamily && <span class="chip">{formatRouteFamily(record.routeFamily)}</span>}
          </div>
          <h3>{record.title}</h3>
          <p class="metric-value">{formatMoney(record.valueGbp)}</p>
          <p class="lede">{record.periodLabel ?? "No period label recorded"}</p>
          <div class="data-list">
            <div class="data-row">
              <span>Buyer</span>
              <span class="data-row-value">{record.buyerName}</span>
            </div>
            <div class="data-row">
              <span>Supplier</span>
              <span class="data-row-value">{record.supplierName ?? "No supplier entity published"}</span>
            </div>
            <div class="data-row">
              <span>Scope</span>
              <span class="data-row-value">{record.scopeClass}</span>
            </div>
          </div>
          <p class="tiny">
            <a class="source-pill" href={record.sourceUrl ?? "#"}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section id="supplier-watchlist" class="section section-anchor priority-section">
    <div class="section-head">
      <div>
        <h2>Supplier and public-body watchlist</h2>
        <p class="lede">
          {supplierWatchlist[0]
            ? `${supplierWatchlist[0].entityName} already features in ${supplierWatchlist[0].publicContractCount} public money rows${supplierWatchlist[0].siteCount > 0 ? ` and ${supplierWatchlist[0].siteCount} linked sites` : ""}. This is where entity-level exposure stops being abstract.`
            : "The watchlist combines visible hotel exposure, public contract rows, and any disclosed contract value already in the starter ledger."}
        </p>
      </div>
    </div>
    <div class="feature-grid">
      {supplierWatchlist.map((supplier) => (
        <article class="feature-card">
          <div class="chip-row">
            <span class="chip accent">{supplier.entityRole}</span>
            {supplier.riskLevel && <span class="chip">{supplier.riskLevel}</span>}
          </div>
          <h3>{supplier.entityName}</h3>
          <p class="metric-value">{supplier.publicContractCount.toLocaleString()}</p>
          <p class="lede">Public money row{supplier.publicContractCount === 1 ? "" : "s"} tied to this profile.</p>
          <div class="data-list">
            <div class="data-row">
              <span>Linked sites</span>
              <span class="data-row-value">{supplier.siteCount.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Published value</span>
              <span class="data-row-value">{formatMoney(supplier.publicContractValueGbp)}</span>
            </div>
            <div class="data-row">
              <span>Route families</span>
              <span class="data-row-value">{supplier.routeFamilies.map(formatRouteFamily).join(", ") || "none"}</span>
            </div>
          </div>
          {supplier.companyNumber && <p class="tiny">Company number: {supplier.companyNumber}</p>}
          <p class="tiny">
            <a class="source-pill" href={`/entities/${supplier.supplierId}/`}>Open entity profile</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  {spendingSiteTrails.length > 0 && (
    <section id="money-site-trails" class="section section-anchor priority-section">
      <div class="section-head">
        <div>
          <h2>Where the money already touches named hotels</h2>
          <p class="lede">
            These rows are the clearest public examples of contract scope, named sites, and place pressure already
            landing on the same evidence chain.
          </p>
        </div>
        <a class="source-pill" href="/hotels#unresolved-watchlist">Open hotel watchlist</a>
      </div>
      <div class="feature-grid">
        {spendingSiteTrails.map((trail) => (
          <InvestigationTrail
            kicker={trail.kicker}
            title={trail.title}
            summary={trail.summary}
            chips={trail.chips}
            tone={trail.tone}
            steps={trail.steps}
            footnote={trail.footnote}
          />
        ))}
      </div>
    </section>
  )}

  <section id="money-composition" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Ledger composition at a glance</h2>
        <p class="lede">
          These visual splits show the structure of the money layer without collapsing unlike rows into one misleading
          total.
        </p>
      </div>
    </div>
    <div class="viz-grid">
      <PathwayMixCard
        title="Route family record mix"
        description="Record counts by route or scheme family currently represented in the starter ledger."
        totalLabel="public rows"
        segments={routeSummaries.map((summary, index) => ({
          label: formatRouteFamily(summary.routeFamily),
          value: summary.recordCount,
          tone: segmentTones[index % segmentTones.length],
          detail: `${summary.rowsWithValue} rows with published value | ${summary.linkedSiteCount} linked sites`
        }))}
        note="Record counts only. This avoids turning tariffs, contract scope, and scrutiny estimates into one fake spend figure."
      />
      <PathwayMixCard
        title="Record type mix"
        description="The ledger keeps contract scope, funding instructions, and scrutiny rows split because they answer different questions."
        totalLabel="public rows"
        segments={recordTypeSummaries.map((summary, index) => ({
          label: recordTypeLabels[summary.recordType] ?? summary.recordType,
          value: summary.recordCount,
          tone: segmentTones[index % segmentTones.length],
          detail:
            summary.rowsWithValue > 0
              ? `${summary.rowsWithValue} rows with published value`
              : "No rows with published value"
        }))}
        note={routeValueLabel}
      />
    </div>
  </section>

  <section class="split section">
    <div class="panel panel-pad">
      <h2>Buyer control</h2>
      <p class="lede">
        Buyer concentration belongs on the page because a small number of public bodies still control most of the
        route-specific money surface.
      </p>
      <div class="signal-list">
        {topBuyers.map((buyer, index) => (
          <article class={`signal-card${index === 0 ? " accent" : ""}`}>
            <div class="chip-row">
              <span class="chip accent">{buyer.recordCount} rows</span>
              <span class="chip">{buyer.routeFamilyCount} route families</span>
            </div>
            <h3>{buyer.buyerName}</h3>
            <p class="tiny">
              {buyer.rowsWithValue} rows with published values | {buyer.linkedSiteCount} linked site
              {buyer.linkedSiteCount === 1 ? "" : "s"}
            </p>
            <p class="tiny">Disclosed value total: {formatMoney(buyer.disclosedValueTotal)}</p>
          </article>
        ))}
      </div>
    </div>

    <RegionTileMap
      items={linkedRegionSummaries.map((summary) => ({ regionName: summary.regionName, value: summary.linkedSiteCount }))}
      title="Named sites linked to money rows by region"
      description={
        leadMoneyRegion
          ? `${leadMoneyRegion.regionName} currently has the largest count of named sites already attached to money rows.`
          : "No named sites are currently linked to money rows."
      }
      valueLabel="linked sites"
      highlightRegion={leadMoneyRegion?.regionName}
      tone="warm"
    />
  </section>

  <section id="money-readout" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>What the ledger already proves</h2>
        <p class="lede">
          The money layer is still small, but it already exposes concentration, missing comparability, and where
          visible sites intersect with public contracts.
        </p>
      </div>
    </div>
    <div class="story-grid">
      {spendingReadoutCards.map((card) => (
        <article class="story-card">
          <h3>{card.title}</h3>
          <p class="lede">{card.body}</p>
        </article>
      ))}
    </div>
  </section>

  <section id="money-presets" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Preset views</h2>
        <p class="lede">
          These saved money views open the most useful ledger slices immediately and keep the existing query-state
          explorer as the underlying model.
        </p>
      </div>
      <span class="chip accent">Deep-link presets</span>
    </div>
    <div class="guide-grid">
      {spendingPresetViews.map((preset) => (
        <article class="guide-card">
          <h3>{preset.title}</h3>
          <p>{preset.body}</p>
          <p class="tiny">
            <a class="source-pill" href={preset.href}>{preset.cta}</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section id="money-explorer" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Explorer and shareable filters</h2>
        <p class="lede">
          This drill-down is URL-synced, so filtered views of the money ledger can be shared directly instead of being
          recreated from scratch every time.
        </p>
      </div>
      <span class="chip accent">Query-state explorer</span>
    </div>

    <div class="filter-panel">
      <form class="filter-grid" data-money-form>
        <label class="filter-field">
          <span class="tiny">Search rows</span>
          <input type="search" name="money_q" placeholder="Buyer, supplier, route, site, or title" />
        </label>
        <label class="filter-field">
          <span class="tiny">Route family</span>
          <select name="money_route">
            <option value="all">All route families</option>
            {moneyRouteOptions.map((routeFamily) => (
              <option value={routeFamily}>{formatRouteFamily(routeFamily)}</option>
            ))}
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Record type</span>
          <select name="money_type">
            <option value="all">All record types</option>
            {moneyTypeOptions.map((recordType) => (
              <option value={recordType}>{recordTypeLabels[recordType] ?? recordType}</option>
            ))}
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Buyer</span>
          <select name="money_buyer">
            <option value="all">All buyers</option>
            {moneyBuyerOptions.map((buyerName) => (
              <option value={buyerName}>{buyerName}</option>
            ))}
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Value status</span>
          <select name="money_value">
            <option value="all">All rows</option>
            <option value="with_value">Rows with published values</option>
            <option value="without_value">Rows without published values</option>
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Scope rule</span>
          <select name="money_scope">
            <option value="all">All scope classes</option>
            {moneyScopeOptions.map((scopeClass) => (
              <option value={scopeClass}>{scopeClass}</option>
            ))}
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Sort rows by</span>
          <select name="money_sort">
            <option value="newest">Newest publication</option>
            <option value="value">Largest published value</option>
            <option value="linked_sites">Most linked named sites</option>
            <option value="title">Title</option>
          </select>
        </label>
      </form>
      <div class="filter-actions">
        <button class="source-pill" type="button" data-money-reset>Reset filters</button>
        <button class="source-pill" type="button" data-money-copy>Copy filtered view</button>
        <span class="tiny filter-status" data-money-copy-status aria-live="polite"></span>
        <span class="tiny" data-money-summary>Showing {moneyLedger.summary.totalRecords.toLocaleString()} public ledger rows</span>
        <span class="tiny" data-money-meta>
          {moneyLedger.summary.rowsWithDisclosedValue.toLocaleString()} rows with values | lead buyer {leadBuyer?.buyerName ?? "not available"}
        </span>
      </div>
    </div>

    <div class="data-pill-grid">
      <article class="guide-card">
        <span class="tiny">Matching rows</span>
        <h3 data-money-result-count>{moneyLedger.summary.totalRecords.toLocaleString()}</h3>
        <p class="tiny">Current ledger rows still visible after filtering.</p>
      </article>
      <article class="guide-card">
        <span class="tiny">Published value total</span>
        <h3 data-money-value-total>
          {moneyLedger.summary.rowsWithDisclosedValue > 0
            ? formatMoney(routeSummaries.reduce((total, summary) => total + summary.disclosedValueTotal, 0))
            : "No published values"}
        </h3>
        <p class="tiny">Only explicit normalized GBP values are counted here.</p>
      </article>
      <article class="guide-card">
        <span class="tiny">Linked named sites</span>
        <h3 data-money-linked-sites>{moneyLedger.summary.linkedNamedSites.toLocaleString()}</h3>
        <p class="tiny">Site links in the visible ledger rows.</p>
      </article>
      <article class="guide-card">
        <span class="tiny">Lead buyer in view</span>
        <h3 data-money-lead-buyer>{leadBuyer?.buyerName ?? "No buyer recorded"}</h3>
        <p class="tiny">Highest-frequency buyer in the current filtered ledger view.</p>
      </article>
    </div>

    <article class="feature-card" data-money-empty hidden>
      <div class="chip-row">
        <span class="chip accent">No matches</span>
      </div>
      <h3>No public money rows match this filter combination</h3>
      <p class="lede">
        Try widening the route family, clearing the buyer filter, or removing the published-value requirement.
      </p>
    </article>
  </section>

  <section id="money-ledger" class="section section-anchor">
    <h2>Current public ledger</h2>
    <div class="table-card">
      <table>
        <caption>Current public money ledger rows with route labels, buyer and supplier context, disclosed values, and linked named sites.</caption>
        <thead>
          <tr>
            <th scope="col">Row</th>
            <th scope="col">Route or scheme</th>
            <th scope="col">Buyer / supplier</th>
            <th scope="col">Value</th>
            <th scope="col">Linked sites</th>
          </tr>
        </thead>
        <tbody data-money-rows>
          {moneyLedger.records.map((record) => (
            <tr
              data-money-row
              data-record-id={record.recordId}
              data-title={record.title}
              data-buyer={record.buyerName}
              data-supplier={record.supplierName ?? ""}
              data-route={record.routeFamily ?? "not_route_specific"}
              data-record-type={record.recordType}
              data-scope={record.scopeClass}
              data-has-value={typeof record.valueGbp === "number" ? "true" : "false"}
              data-value={record.valueGbp ?? 0}
              data-linked-sites={record.linkedSites.length}
              data-site-ids={record.linkedSites.map((site) => site.siteId).join(",")}
              data-published-at={record.publishedDate ?? record.awardDate ?? ""}
              data-search-text={[
                record.title,
                record.buyerName,
                record.supplierName,
                record.routeFamily,
                record.schemeLabel,
                record.periodLabel,
                record.scopeClass,
                ...record.linkedSites.map((site) => `${site.siteName} ${site.areaName} ${site.regionName}`)
              ]
                .filter(Boolean)
                .join(" ")
                .toLowerCase()}
            >
              <th scope="row">
                <strong>{record.title}</strong>
                <div class="chip-row" style="margin-top: 0.5rem;">
                  <span class="chip accent">{recordTypeLabels[record.recordType] ?? record.recordType}</span>
                  <span class={`chip ${record.scopeClass === "route_specific" ? "accent" : record.scopeClass === "local_route_relevant" ? "teal" : ""}`}>
                    {record.scopeClass}
                  </span>
                </div>
                <div class="tiny" style="margin-top: 0.5rem;">
                  <a class="source-pill" href={record.sourceUrl ?? "#"}>Source</a>
                </div>
              </th>
              <td>
                <div>{formatRouteFamily(record.routeFamily)}</div>
                {record.schemeLabel && <div class="tiny">{record.schemeLabel}</div>}
                {record.periodLabel && <div class="tiny">{record.periodLabel}</div>}
              </td>
              <td>
                <div><strong>{record.buyerName}</strong></div>
                <div class="tiny">{record.supplierName ?? "No supplier entity published in row"}</div>
                {record.supplierRole && <div class="tiny">{record.supplierRole}</div>}
              </td>
              <td>
                <div>{formatMoney(record.valueGbp)}</div>
                {record.valueKind && <div class="tiny">{record.valueKind}</div>}
              </td>
              <td>
                {record.linkedSites.length > 0 ? (
                  record.linkedSites.map((site) => (
                    <div class="tiny" style="margin-bottom: 0.5rem;">
                      <strong>{site.siteName}</strong>
                      <div>{site.areaName}</div>
                      <div>{site.entityCoverage}</div>
                    </div>
                  ))
                ) : (
                  <span class="tiny">No site link in starter ledger</span>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <section id="supplier-profiles" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Supplier and public-body profiles</h2>
        <p class="lede">
          The wider ledger still matters, even after the watchlist highlights the most legible supplier exposure.
        </p>
      </div>
    </div>
    <div class="story-grid">
      {topSuppliers.map((supplier) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip accent">{supplier.entityRole}</span>
            <span class="chip">{supplier.riskLevel}</span>
          </div>
          <h3>{supplier.entityName}</h3>
          <p class="lede">
            {supplier.siteCount} linked site{supplier.siteCount === 1 ? "" : "s"} | {supplier.publicContractCount} public
            money row{supplier.publicContractCount === 1 ? "" : "s"}
          </p>
          <p class="tiny">
            Route families: {supplier.routeFamilies.map(formatRouteFamily).join(", ") || "none"}
          </p>
          <p class="tiny">
            Integrity signals: {supplier.integritySignalCount}
          </p>
          {supplier.companyNumber && <p class="tiny">Company number: {supplier.companyNumber}</p>}
          <p class="tiny">
            <a class="source-pill" href={`/entities/${supplier.supplierId}/`}>Open entity profile</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section id="investigative-leads" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Investigative leads already visible in the data</h2>
        <p class="lede">
          These are the clearest current gaps between what the public can map and what the system still withholds.
        </p>
      </div>
    </div>
    <div class="story-grid">
      {moneyLedger.investigativeLeads.map((lead) => (
        <article class="story-card">
          <div class="chip-row">
            <span class={`chip ${lead.severity === "warning" ? "accent" : ""}`}>{lead.severity}</span>
          </div>
          <h3>{lead.title}</h3>
          <p class="lede">{lead.detail}</p>
          <p class="tiny">
            <a class="source-pill" href={lead.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Supplier layers to investigate next</h2>
        <p class="lede">
          The next public gains come from pushing below the prime contract layer and making subcontractor visibility
          publishable.
        </p>
      </div>
    </div>
    <div class="feature-grid">
      {moneyLedger.supplierLayers.map((layer) => (
        <article class="feature-card">
          <div class="chip-row">
            <span class={`chip ${layer.scope === "route_specific" ? "accent" : layer.scope === "local_route_relevant" ? "teal" : ""}`}>
              {layer.scope}
            </span>
          </div>
          <h3>{layer.label}</h3>
          <p class="lede">{layer.description}</p>
          <div class="chip-row">
            {layer.examples.map((example) => (
              <span class="chip">{example}</span>
            ))}
          </div>
          {layer.questions[0] && (
            <article class="signal-card accent">
              <span class="tiny">Question to answer next</span>
              <h3>{layer.questions[0]}</h3>
            </article>
          )}
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Integrity techniques</h2>
    <div class="story-grid">
      {followMoney.integrityTechniques.map((technique) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip accent">{technique.category}</span>
          </div>
          <h3>{technique.label}</h3>
          <p class="lede">{technique.description}</p>
          <p class="tiny">{technique.origin}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section">
    <div class="panel panel-pad">
      <h2>Scope and publish rules</h2>
      <div class="signal-list">
        {asylumFinance.scopeRules.map((rule) => (
          <article class="signal-card">
            <div class="chip-row">
              <span class={`chip ${rule.id === "route_specific" ? "accent" : rule.id === "local_route_relevant" ? "teal" : ""}`}>
                {rule.label}
              </span>
            </div>
            <p class="tiny">{rule.description}</p>
          </article>
        ))}
        {followMoney.publishRules.map((rule) => (
          <article class="signal-card accent">
            <span class="tiny">Publish rule</span>
            <p class="tiny">{rule}</p>
          </article>
        ))}
      </div>
    </div>

    <div class="panel panel-pad">
      <h2>Inclusion test and current limits</h2>
      <div class="signal-list">
        {asylumFinance.inclusionTests.map((rule) => (
          <article class="signal-card">
            <span class="tiny">Inclusion test</span>
            <p class="tiny">{rule}</p>
          </article>
        ))}
        {moneyLedger.limitations.map((item) => (
          <article class="signal-card accent">
            <span class="tiny">Current limit</span>
            <p class="tiny">{item}</p>
          </article>
        ))}
      </div>
    </div>
  </section>

  <script>
    import { initMoneyExplorer } from "../scripts/money-explorer";

    initMoneyExplorer();
  </script>
</BaseLayout>

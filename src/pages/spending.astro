---
import BaseLayout from "../layouts/BaseLayout.astro";
import asylumFinance from "../data/live/asylum-finance.json";
import followMoney from "../data/live/follow-money.json";
import { loadMoneyLedger } from "../lib/money-data";

const moneyLedger = loadMoneyLedger();
const topSuppliers = moneyLedger.supplierProfiles.slice(0, 8);
type MoneyRecordWithValue = (typeof moneyLedger.records)[number] & { valueGbp: number };
const highValueRecords = moneyLedger.records
  .filter((record): record is MoneyRecordWithValue => typeof record.valueGbp === "number")
  .sort((a, b) => b.valueGbp - a.valueGbp)
  .slice(0, 3);
const supplierWatchlist = [...moneyLedger.supplierProfiles]
  .sort(
    (a, b) =>
      (b.publicContractValueGbp ?? 0) - (a.publicContractValueGbp ?? 0) ||
      b.publicContractCount - a.publicContractCount ||
      b.siteCount - a.siteCount
  )
  .slice(0, 4);
const routeCoverage = [...moneyLedger.routeGroups].sort((a, b) => b.recordCount - a.recordCount);
const recordTypeBreakdown = [...moneyLedger.recordTypeGroups].sort((a, b) => b.recordCount - a.recordCount);
const primaryLead = moneyLedger.investigativeLeads[0];

const recordTypeLabels: Record<string, string> = {
  prime_contract_scope: "Prime contract scope",
  funding_instruction: "Funding instruction",
  scrutiny_estimate: "Scrutiny estimate",
  cost_indicator: "Cost indicator",
  local_response_contract: "Local response contract",
  other: "Other"
};

function formatMoney(value: number | null | undefined): string {
  if (typeof value !== "number") {
    return "Not disclosed / not normalized";
  }

  return new Intl.NumberFormat("en-GB", {
    style: "currency",
    currency: "GBP",
    maximumFractionDigits: value >= 1000 ? 0 : 2
  }).format(value);
}
---

<BaseLayout
  title="Spending | asylumstats"
  description="Public money ledger for asylum accommodation, contract scope, official tariff rows, hotel costs, and supplier exposure."
>
  <section class="page-top">
    <section class="page-head">
      <span class="kicker">Spending and contracts</span>
      <h1>Follow the migrants, follow the money, and keep the route labels honest.</h1>
      <p>
        The public money layer now has a real starter ledger behind it. It mixes prime contract scope, official funding
        instructions, and scrutiny cost rows so the public can see where money is documented, where it is estimated,
        and where the supplier chain still disappears into opacity.
      </p>
    </section>

    <aside class="page-rail">
      <article class="panel panel-pad">
        <span class="tiny">Money layer snapshot</span>
        <p class="rail-copy">
          The goal is not one spend total. It is to separate disclosed values, contractual control, and scrutiny
          evidence clearly enough that the missing pieces stand out.
        </p>
        <div class="stat-strip">
          <article class="stat-tile">
            <span class="tiny">Ledger rows</span>
            <strong>{moneyLedger.summary.totalRecords.toLocaleString()}</strong>
            <p class="tiny">Contracts, tariffs, and scrutiny rows.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Rows with published values</span>
            <strong>{moneyLedger.summary.rowsWithDisclosedValue.toLocaleString()}</strong>
            <p class="tiny">Explicit GBP values only.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Route families covered</span>
            <strong>{moneyLedger.summary.routeFamiliesCovered.toLocaleString()}</strong>
            <p class="tiny">Distinct route families in the starter ledger.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Linked named sites</span>
            <strong>{moneyLedger.summary.linkedNamedSites.toLocaleString()}</strong>
            <p class="tiny">Visible hotels tied to money rows.</p>
          </article>
        </div>
      </article>

      {primaryLead && (
        <article class="panel panel-pad">
          <span class="tiny">Priority lead</span>
          <h2 class="rail-title">{primaryLead.title}</h2>
          <p class="rail-copy">{primaryLead.detail}</p>
          <div class="chip-row">
            <span class={`chip ${primaryLead.severity === "warning" ? "accent" : ""}`}>{primaryLead.severity}</span>
            <a class="source-pill" href={primaryLead.sourceUrl}>Source</a>
          </div>
        </article>
      )}
    </aside>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Where the public values already exist</h2>
        <p class="lede">
          The starter ledger already contains large public figures. They need clear route labels and context, not
          flattening into one misleading spend total.
        </p>
      </div>
      <span class="chip">{moneyLedger.summary.uniqueSuppliers.toLocaleString()} suppliers or public bodies tracked</span>
    </div>
    <div class="feature-grid">
      {highValueRecords.map((record) => (
        <article class="feature-card accent">
          <div class="chip-row">
            <span class="chip accent">{recordTypeLabels[record.recordType] ?? record.recordType}</span>
            {record.routeFamily && <span class="chip">{record.routeFamily}</span>}
          </div>
          <h3>{record.title}</h3>
          <p class="metric-value">{formatMoney(record.valueGbp)}</p>
          <p class="lede">{record.periodLabel ?? "No period label recorded"}</p>
          <div class="data-list">
            <div class="data-row">
              <span>Buyer</span>
              <span class="data-row-value">{record.buyerName}</span>
            </div>
            <div class="data-row">
              <span>Supplier</span>
              <span class="data-row-value">{record.supplierName ?? "No supplier entity published"}</span>
            </div>
            <div class="data-row">
              <span>Scope</span>
              <span class="data-row-value">{record.scopeClass}</span>
            </div>
          </div>
          <p class="tiny">
            <a class="source-pill" href={record.sourceUrl ?? "#"}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section">
    <div class="panel panel-pad">
      <h2>Route coverage</h2>
      <div class="signal-list">
        {routeCoverage.map((group) => (
          <article class="signal-card">
            <div class="chip-row">
              <span class="chip accent">{group.recordCount} rows</span>
              <span class="chip">{group.rowsWithValue} with value</span>
            </div>
            <h3>{group.routeFamily}</h3>
          </article>
        ))}
      </div>
    </div>

    <div class="panel panel-pad">
      <h2>Ledger composition</h2>
      <div class="signal-list">
        {recordTypeBreakdown.map((group) => (
          <article class="signal-card accent">
            <div class="chip-row">
              <span class="chip accent">{group.recordCount} rows</span>
            </div>
            <h3>{recordTypeLabels[group.recordType] ?? group.recordType}</h3>
          </article>
        ))}
      </div>
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Supplier and public-body watchlist</h2>
        <p class="lede">
          The watchlist combines visible hotel exposure, public contract rows, and any disclosed contract value already
          in the starter ledger.
        </p>
      </div>
    </div>
    <div class="feature-grid">
      {supplierWatchlist.map((supplier) => (
        <article class="feature-card">
          <div class="chip-row">
            <span class="chip accent">{supplier.entityRole}</span>
            {supplier.riskLevel && <span class="chip">{supplier.riskLevel}</span>}
          </div>
          <h3>{supplier.entityName}</h3>
          <p class="metric-value">{supplier.publicContractCount.toLocaleString()}</p>
          <p class="lede">Public money row{supplier.publicContractCount === 1 ? "" : "s"} tied to this profile.</p>
          <div class="data-list">
            <div class="data-row">
              <span>Linked sites</span>
              <span class="data-row-value">{supplier.siteCount.toLocaleString()}</span>
            </div>
            <div class="data-row">
              <span>Published value</span>
              <span class="data-row-value">{formatMoney(supplier.publicContractValueGbp)}</span>
            </div>
            <div class="data-row">
              <span>Route families</span>
              <span class="data-row-value">{supplier.routeFamilies.join(", ") || "none"}</span>
            </div>
          </div>
          {supplier.companyNumber && <p class="tiny">Company number: {supplier.companyNumber}</p>}
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Current public ledger</h2>
    <div class="table-card">
      <table>
        <caption>Current public money ledger rows with route labels, buyer and supplier context, disclosed values, and linked named sites.</caption>
        <thead>
          <tr>
            <th scope="col">Row</th>
            <th scope="col">Route or scheme</th>
            <th scope="col">Buyer / supplier</th>
            <th scope="col">Value</th>
            <th scope="col">Linked sites</th>
          </tr>
        </thead>
        <tbody>
          {moneyLedger.records.map((record) => (
            <tr>
              <th scope="row">
                <strong>{record.title}</strong>
                <div class="chip-row" style="margin-top: 0.5rem;">
                  <span class="chip accent">{recordTypeLabels[record.recordType] ?? record.recordType}</span>
                  <span class={`chip ${record.scopeClass === "route_specific" ? "accent" : record.scopeClass === "local_route_relevant" ? "teal" : ""}`}>
                    {record.scopeClass}
                  </span>
                </div>
                <div class="tiny" style="margin-top: 0.5rem;">
                  <a class="source-pill" href={record.sourceUrl ?? "#"}>Source</a>
                </div>
              </th>
              <td>
                <div>{record.routeFamily ?? "Not route-specific"}</div>
                {record.schemeLabel && <div class="tiny">{record.schemeLabel}</div>}
                {record.periodLabel && <div class="tiny">{record.periodLabel}</div>}
              </td>
              <td>
                <div><strong>{record.buyerName}</strong></div>
                <div class="tiny">{record.supplierName ?? "No supplier entity published in row"}</div>
                {record.supplierRole && <div class="tiny">{record.supplierRole}</div>}
              </td>
              <td>
                <div>{formatMoney(record.valueGbp)}</div>
                {record.valueKind && <div class="tiny">{record.valueKind}</div>}
              </td>
              <td>
                {record.linkedSites.length > 0 ? (
                  record.linkedSites.map((site) => (
                    <div class="tiny" style="margin-bottom: 0.5rem;">
                      <strong>{site.siteName}</strong>
                      <div>{site.areaName}</div>
                      <div>{site.entityCoverage}</div>
                    </div>
                  ))
                ) : (
                  <span class="tiny">No site link in starter ledger</span>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Supplier and public-body profiles</h2>
        <p class="lede">
          The wider ledger still matters, even after the watchlist highlights the most legible supplier exposure.
        </p>
      </div>
    </div>
    <div class="story-grid">
      {topSuppliers.map((supplier) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip accent">{supplier.entityRole}</span>
            <span class="chip">{supplier.riskLevel}</span>
          </div>
          <h3>{supplier.entityName}</h3>
          <p class="lede">
            {supplier.siteCount} linked site{supplier.siteCount === 1 ? "" : "s"} | {supplier.publicContractCount} public
            money row{supplier.publicContractCount === 1 ? "" : "s"}
          </p>
          <p class="tiny">
            Route families: {supplier.routeFamilies.join(", ") || "none"}
          </p>
          <p class="tiny">
            Integrity signals: {supplier.integritySignalCount}
          </p>
          {supplier.companyNumber && <p class="tiny">Company number: {supplier.companyNumber}</p>}
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Investigative leads already visible in the data</h2>
        <p class="lede">
          These are the clearest current gaps between what the public can map and what the system still withholds.
        </p>
      </div>
    </div>
    <div class="story-grid">
      {moneyLedger.investigativeLeads.map((lead) => (
        <article class="story-card">
          <div class="chip-row">
            <span class={`chip ${lead.severity === "warning" ? "accent" : ""}`}>{lead.severity}</span>
          </div>
          <h3>{lead.title}</h3>
          <p class="lede">{lead.detail}</p>
          <p class="tiny">
            <a class="source-pill" href={lead.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Supplier layers to investigate next</h2>
        <p class="lede">
          The next public gains come from pushing below the prime contract layer and making subcontractor visibility
          publishable.
        </p>
      </div>
    </div>
    <div class="feature-grid">
      {moneyLedger.supplierLayers.map((layer) => (
        <article class="feature-card">
          <div class="chip-row">
            <span class={`chip ${layer.scope === "route_specific" ? "accent" : layer.scope === "local_route_relevant" ? "teal" : ""}`}>
              {layer.scope}
            </span>
          </div>
          <h3>{layer.label}</h3>
          <p class="lede">{layer.description}</p>
          <div class="chip-row">
            {layer.examples.map((example) => (
              <span class="chip">{example}</span>
            ))}
          </div>
          {layer.questions[0] && (
            <article class="signal-card accent">
              <span class="tiny">Question to answer next</span>
              <h3>{layer.questions[0]}</h3>
            </article>
          )}
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Integrity techniques</h2>
    <div class="story-grid">
      {followMoney.integrityTechniques.map((technique) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip accent">{technique.category}</span>
          </div>
          <h3>{technique.label}</h3>
          <p class="lede">{technique.description}</p>
          <p class="tiny">{technique.origin}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section">
    <div class="panel panel-pad">
      <h2>Scope and publish rules</h2>
      <div class="signal-list">
        {asylumFinance.scopeRules.map((rule) => (
          <article class="signal-card">
            <div class="chip-row">
              <span class={`chip ${rule.id === "route_specific" ? "accent" : rule.id === "local_route_relevant" ? "teal" : ""}`}>
                {rule.label}
              </span>
            </div>
            <p class="tiny">{rule.description}</p>
          </article>
        ))}
        {followMoney.publishRules.map((rule) => (
          <article class="signal-card accent">
            <span class="tiny">Publish rule</span>
            <p class="tiny">{rule}</p>
          </article>
        ))}
      </div>
    </div>

    <div class="panel panel-pad">
      <h2>Inclusion test and current limits</h2>
      <div class="signal-list">
        {asylumFinance.inclusionTests.map((rule) => (
          <article class="signal-card">
            <span class="tiny">Inclusion test</span>
            <p class="tiny">{rule}</p>
          </article>
        ))}
        {moneyLedger.limitations.map((item) => (
          <article class="signal-card accent">
            <span class="tiny">Current limit</span>
            <p class="tiny">{item}</p>
          </article>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

---
import BaseLayout from "../../layouts/BaseLayout.astro";
import InvestigationTrail from "../../components/InvestigationTrail.astro";
import PageContents from "../../components/PageContents.astro";
import BenchmarkStrip from "../../components/BenchmarkStrip.astro";
import RegionTileMap from "../../components/RegionTileMap.astro";
import TrendChart from "../../components/TrendChart.astro";
import {
  buildSupportedAsylumStockDescription,
  supportedAsylumReadingRules
} from "../../lib/asylum-support-logic";
import { getAreaTrendSummary } from "../../lib/area-series";
import { getEntityProfileByReference, getLeadEntityProfileForTrail } from "../../lib/entities";
import { loadLocalRouteLatest } from "../../lib/route-data";
import { loadHotelEntityLedger } from "../../lib/hotel-data";
import { getPlaceInvestigationTrails } from "../../lib/investigations";
import { loadMoneyLedger } from "../../lib/money-data";
import { buildAbsoluteUrl, buildPlaceStructuredData, getPublicPlaceAreas } from "../../lib/site";
import { getPlaceDrilldownMetrics } from "../../lib/place-drilldown";
import { getDistributionStats, getPercentileRank, getRegionPressureSummaries } from "../../lib/route-analytics";

const localRouteLatest = loadLocalRouteLatest();
const hotelLedger = loadHotelEntityLedger();
const moneyLedger = loadMoneyLedger();

export function getStaticPaths() {
  return getPublicPlaceAreas().map((area) => ({
    params: { code: area.areaCode },
    props: { area }
  }));
}

const { area } = Astro.props;
const hotelSites = hotelLedger.sites.filter(
  (site) => site.areaCode === area.areaCode || site.areaName === area.areaName
);
const hotelArea = hotelLedger.areas.find(
  (a) => a.areaCode === area.areaCode || a.areaName === area.areaName
);
const namedSiteCount = hotelSites.filter((s) => s.status === "current").length;
const unnamedSiteCount = hotelArea?.unnamedSiteCount ?? 0;
const regionalAreas = [...localRouteLatest.areas]
  .filter((candidate) => candidate.regionName === area.regionName)
  .sort((a, b) => b.supportedAsylum - a.supportedAsylum);
const regionalRank = regionalAreas.findIndex((candidate) => candidate.areaCode === area.areaCode) + 1;
const regionalPeerRows = (() => {
  const leadingPeers = regionalAreas.slice(0, 5);

  if (leadingPeers.some((candidate) => candidate.areaCode === area.areaCode)) {
    return leadingPeers;
  }

  return [...leadingPeers, area];
})();
const areaRank =
  [...localRouteLatest.areas]
    .sort((a, b) => b.supportedAsylum - a.supportedAsylum)
    .findIndex((candidate) => candidate.areaCode === area.areaCode) + 1;
const contingencyRank =
  [...localRouteLatest.areas]
    .sort((a, b) => b.contingencyAccommodation - a.contingencyAccommodation)
    .findIndex((candidate) => candidate.areaCode === area.areaCode) + 1;
const pathwayBreakdown = [
  { label: "Supported asylum", value: area.supportedAsylum },
  { label: "Homes for Ukraine", value: area.homesForUkraineArrivals },
  { label: "Afghan programme", value: area.afghanProgrammePopulation },
  { label: "Resettlement cumulative", value: area.resettlementCumulativeTotal ?? 0 }
];
const maxPathwayValue = Math.max(...pathwayBreakdown.map((item) => item.value), 1);
const hotelSignals = hotelSites
  .flatMap((site) =>
    site.integritySignals.map((signal) => ({
      siteName: site.siteName,
      headline: signal.headline,
      detail: signal.detail,
      severity: signal.severity
    }))
  )
  .slice(0, 3);
const areaTrend = getAreaTrendSummary(area.areaCode);
const previousTrendPoint = areaTrend ? areaTrend.points[areaTrend.points.length - 2] ?? null : null;
const placeDrilldownMetrics = getPlaceDrilldownMetrics(localRouteLatest.areas, area);
const placeInvestigationTrails = getPlaceInvestigationTrails(area, hotelLedger, moneyLedger, localRouteLatest.areas, 3);
const regionalPressure = getRegionPressureSummaries(localRouteLatest.areas);
const currentRegion = regionalPressure.find((region) => region.regionName === area.regionName);
const supportedStats = getDistributionStats(localRouteLatest.areas.map((candidate) => candidate.supportedAsylum));
const supportedRateStats = getDistributionStats(
  localRouteLatest.areas.map((candidate) => candidate.supportedAsylumRate ?? 0)
);
const contingencyStats = getDistributionStats(
  localRouteLatest.areas.map((candidate) => candidate.contingencyAccommodation)
);
const supportedPercentile = getPercentileRank(
  localRouteLatest.areas.map((candidate) => candidate.supportedAsylum),
  area.supportedAsylum
);
const ratePercentile = getPercentileRank(
  localRouteLatest.areas.map((candidate) => candidate.supportedAsylumRate ?? 0),
  area.supportedAsylumRate ?? 0
);
const contingencyPercentile = getPercentileRank(
  localRouteLatest.areas.map((candidate) => candidate.contingencyAccommodation),
  area.contingencyAccommodation
);
const contingencySharePct = area.supportedAsylum
  ? Number(((area.contingencyAccommodation / area.supportedAsylum) * 100).toFixed(1))
  : 0;
const regionalPeerMax = Math.max(...regionalPeerRows.map((candidate) => candidate.supportedAsylum), 1);
const secondaryPathways = [
  { label: "Homes for Ukraine", value: area.homesForUkraineArrivals },
  { label: "Afghan programme", value: area.afghanProgrammePopulation },
  { label: "Resettlement cumulative", value: area.resettlementCumulativeTotal ?? 0 }
].sort((a, b) => b.value - a.value);
const leadingSecondaryPathway = secondaryPathways[0];
const editorialSignals = [
  {
    kicker: "Volume",
    title:
      areaRank <= 10
        ? `${area.areaName} is one of the highest-volume asylum support areas in the UK`
        : `${area.areaName} is outside the top ten by volume, but still carries a material local load`,
    body: `${area.areaName} ranks ${areaRank.toLocaleString()} nationally and ${regionalRank.toLocaleString()} in ${area.regionName} for supported asylum count, placing it around the ${supportedPercentile}th percentile of local authorities by volume.`
  },
  {
    kicker: "Intensity",
    title:
      ratePercentile >= 90
        ? "Intensity is stronger than the raw count alone suggests"
        : "The rate picture is important, even where the headline count is lower",
    body: `The supported asylum rate here is ${area.supportedAsylumRate ?? "n/a"} per 10,000 residents, around the ${ratePercentile}th percentile nationally. This matters because smaller places can carry a sharper load than bigger city totals imply.`
  },
  {
    kicker: "Accommodation model",
    title:
      contingencySharePct >= 35
        ? "A large share of support is sitting in contingency accommodation"
        : "The local picture leans more toward dispersal than contingency pressure",
    body:
      contingencySharePct > 0
        ? `${area.contingencyAccommodation.toLocaleString()} people are in contingency accommodation here, around ${contingencySharePct}% of the supported asylum population and roughly the ${contingencyPercentile}th percentile by contingency count.`
        : "No contingency accommodation is recorded for this area in the latest local-authority snapshot, which makes it structurally different from hotel-heavy pressure points."
  },
  {
    kicker: "Visibility",
    title:
      namedSiteCount > 0 || unnamedSiteCount > 0
        ? "There is already enough public hotel evidence here to make the secrecy gap concrete"
        : "The hotel layer is still mostly invisible in public records here",
    body:
      namedSiteCount > 0 || unnamedSiteCount > 0
        ? `${namedSiteCount} named current site${namedSiteCount === 1 ? "" : "s"} and ${unnamedSiteCount} unnamed publicly acknowledged site${unnamedSiteCount === 1 ? "" : "s"} are attached to this area in the starter ledger.`
        : "No named current site or unnamed acknowledged count is attached to this area yet, which is itself a reminder that absence of public evidence is not evidence of absence."
  }
];
const editorialParagraphs = [
  `${area.areaName} sits ${areaRank.toLocaleString()} nationally by supported asylum count and ${regionalRank.toLocaleString()} within ${area.regionName}. The raw volume is ${area.supportedAsylum.toLocaleString()}, but the rate of ${area.supportedAsylumRate ?? "n/a"} per 10,000 residents gives a cleaner sense of local intensity than the headline count on its own.`,
  leadingSecondaryPathway.value > 0
    ? `${leadingSecondaryPathway.label} is the largest non-asylum pathway in this area at ${leadingSecondaryPathway.value.toLocaleString()}. That matters because the local story is not just about one route family; it is about how asylum support, humanitarian schemes, and historic resettlement stack together in one place.`
    : `The main local story here is concentrated in asylum support rather than the other humanitarian pathways, which makes accommodation mode and contingency use especially important.`,
  currentRegion
    ? `${area.regionName} as a whole currently carries ${currentRegion.supportedAsylum.toLocaleString()} people on supported asylum, with a weighted regional rate of ${currentRegion.supportedAsylumRate} per 10,000 residents. This page puts ${area.areaName} inside that wider regional pressure field instead of treating it as an isolated case.`
    : `${area.regionName} is part of a wider regional pressure pattern that matters as much as the local area headline alone.`
];
const pageDescription = `${area.areaName} asylum profile with supported asylum counts, contingency accommodation, route pathway context, and hotel evidence as at ${localRouteLatest.snapshotDate}.`;
const pageStructuredData = buildPlaceStructuredData(area, {
  canonicalUrl: buildAbsoluteUrl(Astro.url.pathname),
  description: pageDescription,
  socialImageUrl: buildAbsoluteUrl("/og-card.png"),
  snapshotDate: localRouteLatest.snapshotDate,
  areaRank,
  contingencyRank,
  namedSiteCount,
  unnamedSiteCount
});
const placeSections = [
  { id: "stock-logic", label: "How to read" },
  ...(areaTrend ? [{ id: "recent-trend", label: "Trend" }] : []),
  { id: "place-drilldown", label: "Drill-down" },
  { id: "local-benchmarks", label: "Benchmarks" },
  { id: "editorial-readout", label: "Readout" },
  ...(placeInvestigationTrails.length > 0 ? [{ id: "evidence-chain", label: "Evidence chain" }] : []),
  { id: "route-metrics", label: "Metrics" },
  { id: "regional-peers", label: "Peers" },
  { id: "hotel-evidence", label: "Hotels" },
  ...(hotelSignals.length > 0 ? [{ id: "integrity-signals", label: "Signals" }] : [])
];

function getSiteEntityProfiles(site: (typeof hotelSites)[number]) {
  const matches = [
    ...site.entityLinks.map((link) => getEntityProfileByReference(link.entityName, link.companyNumber)),
    site.primeProvider ? getEntityProfileByReference(site.primeProvider.provider, null) : null
  ].filter((profile): profile is NonNullable<typeof profile> => profile !== null && profile !== undefined);

  return [...new Map(matches.map((profile) => [profile.entityId, profile])).values()];
}
---

<BaseLayout
  title={`${area.areaName} | asylumstats`}
  description={pageDescription}
  structuredData={pageStructuredData}
>
  <section class="page-top">
    <section class="page-head">
      <span class="kicker">{area.regionName}</span>
      <h1>{area.areaName}</h1>
      <p>
        Official local-authority snapshot as at {localRouteLatest.snapshotDate}. This page keeps live route data and
        local hotel evidence on one place-level surface so pressure can be read in context. Supported asylum here means
        people on support at that quarter end, not the number of different people whose claims were processed locally,
        and not a one-word substitute for the backlog.
      </p>
      <div class="chip-row">
        <span class="chip">{area.countryName}</span>
        <span class="chip teal">Population {area.population?.toLocaleString() ?? "n/a"}</span>
        <span class="chip accent">Supported asylum {area.supportedAsylum.toLocaleString()}</span>
      </div>
    </section>

    <aside class="page-rail">
      <article class="panel panel-pad">
        <span class="tiny">Local pressure position</span>
        <div class="stat-strip">
          <article class="stat-tile">
            <span class="tiny">UK area rank by supported asylum</span>
            <strong>{areaRank.toLocaleString()}</strong>
            <p class="tiny">Across all local authority rows in the live dataset.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Supported asylum rate</span>
            <strong>{area.supportedAsylumRate ?? "n/a"}</strong>
            <p class="tiny">Per 10,000 residents.</p>
          </article>
          <article class="stat-tile">
            <span class="tiny">Contingency rank</span>
            <strong>{contingencyRank.toLocaleString()}</strong>
            <p class="tiny">By contingency accommodation count.</p>
          </article>
        </div>
      </article>

      <article class="panel panel-pad">
        <span class="tiny">Hotel visibility</span>
        <h2 class="rail-title">
          {namedSiteCount > 0 ? `${namedSiteCount} named current site${namedSiteCount > 1 ? "s" : ""}` : "No named current sites"}
        </h2>
        <p class="rail-copy">
          {hotelArea && hotelArea.unnamedSiteCount > 0
            ? `${hotelArea.unnamedSiteCount} unnamed site${hotelArea.unnamedSiteCount > 1 ? "s are" : " is"} also publicly acknowledged here.`
            : "No unnamed hotel count is attached to this area in the starter ledger."}
        </p>
      </article>
    </aside>
  </section>

  <PageContents sections={placeSections} />

  <section id="stock-logic" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>How to read the asylum numbers here</h2>
        <p class="lede">
          A flat or slowly moving local line does not prove the same people stayed on support, and it does not prove
          claims were not being processed. It only shows the quarter-end stock that remained on support, which overlaps
          with but is not identical to the awaiting-decision backlog.
        </p>
      </div>
      <span class="chip accent">Core logic</span>
    </div>
    <div class="story-grid">
      {supportedAsylumReadingRules.map((rule) => (
        <article class="story-card">
          <h3>{rule.title}</h3>
          <p class="lede">{rule.body}</p>
        </article>
      ))}
    </div>
  </section>

  {areaTrend && (
    <section id="recent-trend" class="split section section-anchor">
      <TrendChart
        points={areaTrend.points.map((point) => ({ label: point.label, value: point.value }))}
        title={`Quarter-end supported asylum stock in ${area.areaName}`}
        description={buildSupportedAsylumStockDescription(
          areaTrend.latestPeriodLabel,
          areaTrend.hasIllustrativeData
        )}
        tone={(areaTrend.deltaFromPrevious ?? areaTrend.deltaFromFirst) > 0 ? "warm" : "teal"}
      />

      <article class="panel panel-pad">
        <div class="chip-row">
          <span class="chip accent">Trend readout</span>
          <span class="chip">{areaTrend.latestPeriodLabel}</span>
        </div>
        <h2>Recent path and evidence quality</h2>
        <div class="signal-list">
          <article class={`signal-card${(areaTrend.deltaFromPrevious ?? 0) > 0 ? " accent" : ""}`}>
            <span class="tiny">Latest net stock move</span>
            <h3>
              {areaTrend.deltaFromPrevious !== null
                ? `${areaTrend.deltaFromPrevious >= 0 ? "+" : ""}${areaTrend.deltaFromPrevious.toLocaleString()} since ${previousTrendPoint?.label ?? "the previous point"}`
                : "Only one published trend point"}
            </h3>
            <p class="tiny">
              {areaTrend.changePctFromPrevious !== null
                ? `${areaTrend.changePctFromPrevious >= 0 ? "+" : ""}${areaTrend.changePctFromPrevious}% net change in quarter-end stock by the latest step.`
                : "Quarter-on-quarter change cannot be calculated from a single point."}
            </p>
          </article>
          <article class="signal-card">
            <span class="tiny">Net change across visible series</span>
            <h3>
              {areaTrend.deltaFromFirst >= 0 ? "+" : ""}
              {areaTrend.deltaFromFirst.toLocaleString()} across the visible series
            </h3>
            <p class="tiny">
              {areaTrend.changePctFromFirst !== null
                ? `${areaTrend.changePctFromFirst >= 0 ? "+" : ""}${areaTrend.changePctFromFirst}% change in quarter-end stock from the first visible point to ${areaTrend.latestPeriodLabel}.`
                : "Percentage change from the first visible point cannot be calculated."}
            </p>
          </article>
          <article class="signal-card">
            <span class="tiny">Series quality</span>
            <h3>
              {areaTrend.officialAnchorCount} official quarter point{areaTrend.officialAnchorCount === 1 ? "" : "s"}
            </h3>
            <p class="tiny">
              {areaTrend.hasIllustrativeData
                ? `${areaTrend.illustrativeCount} illustrative bridge point${areaTrend.illustrativeCount === 1 ? "" : "s"} remain in the visible series, so this section is a directional reading rather than a full official quarterly run.`
                : "The visible trend line is built entirely from official quarter-end supported asylum values in the local area series."}
            </p>
          </article>
        </div>
      </article>
    </section>
  )}

  <section id="place-drilldown" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Interactive place drill-down</h2>
        <p class="lede">
          Switch metric and comparison frame to read {area.areaName} as a pressure leader, rate outlier, contingency
          site, or three-pathway case without leaving the page.
        </p>
      </div>
      <span class="chip accent">Shareable place lens</span>
    </div>

    <div class="filter-panel">
      <form class="filter-grid" data-place-drill-form>
        <label class="filter-field">
          <span class="tiny">Metric</span>
          <select name="place_metric">
            {placeDrilldownMetrics.map((metric) => (
              <option value={metric.id}>{metric.label}</option>
            ))}
          </select>
        </label>
        <label class="filter-field">
          <span class="tiny">Comparison frame</span>
          <select name="place_scope">
            <option value="regional">Regional peers</option>
            <option value="national">National ranking</option>
          </select>
        </label>
      </form>
      <div class="filter-actions">
        <button class="source-pill" type="button" data-place-drill-reset>Reset lens</button>
        <span class="tiny" data-place-drill-summary>
          {placeDrilldownMetrics[0]?.views[0]?.summary ?? `${area.areaName} in regional context.`}
        </span>
      </div>
    </div>

    <div class="drilldown-grid">
      {placeDrilldownMetrics.map((metric) =>
        metric.views.map((view) => (
          <article
            class="drilldown-card"
            data-place-drill-panel
            data-metric={metric.id}
            data-scope={view.scope}
            data-summary={view.summary}
            hidden={!(metric.id === "supported_asylum" && view.scope === "regional")}
          >
            <div class="chip-row">
              <span class="chip accent">{metric.label}</span>
              <span class="chip">{view.scope === "regional" ? area.regionName : "United Kingdom"}</span>
            </div>
            <h3>{metric.description}</h3>
            <p class="lede">{view.summary}</p>
            <div class="drilldown-meta">
              <article class="signal-card">
                <span class="tiny">Current value</span>
                <strong>{metric.currentValueLabel}</strong>
              </article>
              <article class="signal-card">
                <span class="tiny">{view.scope === "regional" ? "Regional rank" : "National rank"}</span>
                <strong>
                  #{view.scope === "regional" ? metric.regionalRank.toLocaleString() : metric.nationalRank.toLocaleString()}
                </strong>
              </article>
              <article class="signal-card">
                <span class="tiny">National percentile</span>
                <strong>{metric.percentile}th</strong>
              </article>
            </div>
            <div class="drilldown-list">
              {view.rows.map((row) => (
                <a class="drilldown-row-link" href={row.href}>
                  <div class="metric-bar">
                    <div style="min-width: 12rem;">
                      <strong>{row.areaName}</strong>
                      <div class="tiny">
                        {row.secondaryLabel} | {row.valueLabel}
                      </div>
                    </div>
                    <div class="metric-track">
                      <div class="metric-fill" style={`width: ${row.widthPct}%`}></div>
                    </div>
                  </div>
                </a>
              ))}
            </div>
          </article>
        ))
      )}
    </div>
  </section>

  <section id="pathway-breakdown" class="split section">
    <div class="panel panel-pad">
      <h2>Pathway breakdown</h2>
      <p class="lede">
        The local picture only becomes legible when supported asylum, contingency use, Ukraine arrivals, and Afghan
        programme population are kept distinct.
      </p>
      {pathwayBreakdown.map((item) => (
        <div class="metric-bar">
          <div style="min-width: 11rem;">
            <strong>{item.label}</strong>
            <div class="tiny">{item.value.toLocaleString()}</div>
          </div>
          <div class="metric-track">
            <div class="metric-fill" style={`width: ${(item.value / maxPathwayValue) * 100}%`}></div>
          </div>
        </div>
      ))}
    </div>

    <div class="panel panel-pad">
      <h2>What stands out here</h2>
      <div class="signal-list">
        <article class="signal-card accent">
          <span class="tiny">Pressure profile</span>
          <h3>{area.areaName} is carrying a real asylum-support load</h3>
          <p class="tiny">
            {area.supportedAsylum.toLocaleString()} people are on asylum support here at quarter end, with a rate of{" "}
            {area.supportedAsylumRate ?? "n/a"} per 10,000 residents.
            {area.contingencyAccommodation > 0
              ? ` ${area.contingencyAccommodation.toLocaleString()} are in contingency accommodation.`
              : " No contingency accommodation is recorded for this area."}
          </p>
        </article>
        <article class="signal-card">
          <span class="tiny">Three-pathway load</span>
          <h3>{area.allThreePathwaysTotal.toLocaleString()} people across the main local pathways</h3>
          <p class="tiny">
            This combines supported asylum, Homes for Ukraine arrivals, and Afghan programme population, representing{" "}
            {area.shareOfPopulationPct ?? "n/a"}% of the local population.
          </p>
        </article>
        <article class="signal-card">
          <span class="tiny">Hotel visibility</span>
          <h3>{namedSiteCount > 0 ? "Public hotel evidence exists here" : "Public hotel evidence is still thin here"}</h3>
          <p class="tiny">
            {namedSiteCount > 0
              ? `${namedSiteCount} named current hotel site${namedSiteCount > 1 ? "s are" : " is"} logged in the entity ledger for this area.`
              : "No named current hotel site is attached to this area in the starter ledger yet."}
            {hotelArea && hotelArea.unnamedSiteCount > 0
              ? ` ${hotelArea.unnamedSiteCount} unnamed site${hotelArea.unnamedSiteCount > 1 ? "s are" : " is"} publicly acknowledged as well.`
              : ""}
          </p>
        </article>
      </div>
    </div>
  </section>

  <section id="local-benchmarks" class="split section section-anchor">
    <div class="panel panel-pad">
      <h2>National benchmarks</h2>
      <p class="lede">
        These strips show where {area.areaName} sits in the national distribution for the most important place-level
        pressure measures.
      </p>
      <div class="benchmark-grid">
        <BenchmarkStrip
          label="Supported asylum count"
          description="National distribution across all local-authority rows."
          value={area.supportedAsylum}
          min={supportedStats.min}
          median={supportedStats.median}
          p90={supportedStats.p90}
          max={supportedStats.max}
          valueLabel={area.supportedAsylum.toLocaleString()}
        />
        <BenchmarkStrip
          label="Supported asylum rate"
          description="Rate per 10,000 residents."
          value={area.supportedAsylumRate ?? 0}
          min={supportedRateStats.min}
          median={supportedRateStats.median}
          p90={supportedRateStats.p90}
          max={supportedRateStats.max}
          valueLabel={area.supportedAsylumRate !== null ? `${area.supportedAsylumRate}` : "n/a"}
          tone="teal"
        />
        <BenchmarkStrip
          label="Contingency accommodation"
          description="Hotel and other contingency placements."
          value={area.contingencyAccommodation}
          min={contingencyStats.min}
          median={contingencyStats.median}
          p90={contingencyStats.p90}
          max={contingencyStats.max}
          valueLabel={area.contingencyAccommodation.toLocaleString()}
          tone="warm"
        />
      </div>
    </div>

    <RegionTileMap
      items={regionalPressure.map((region) => ({ regionName: region.regionName, value: region.supportedAsylum }))}
      title="Regional pressure context"
      description={`${area.regionName} is highlighted so this place can be read inside the wider regional supported asylum map.`}
      valueLabel="supported asylum total"
      highlightRegion={area.regionName}
    />
  </section>

  <section id="editorial-readout" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Editorial readout</h2>
        <p class="lede">
          These cards translate the data into the most defensible local claims the site can make right now.
        </p>
      </div>
      <span class="chip">{localRouteLatest.snapshotDate} evidence frame</span>
    </div>
    <div class="story-grid">
      {editorialSignals.map((signal) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip accent">{signal.kicker}</span>
          </div>
          <h3>{signal.title}</h3>
          <p class="lede">{signal.body}</p>
        </article>
      ))}
    </div>
  </section>

  {placeInvestigationTrails.length > 0 && (
    <section id="evidence-chain" class="section section-anchor">
      <div class="section-head">
        <div>
          <h2>Evidence chain in this place</h2>
          <p class="lede">
            These trails connect the visible hotel estate, the linked money surface, and the local pressure frame so the
            area can be read as one investigation rather than separate ledgers.
          </p>
        </div>
        <a class="source-pill" href="/spending#money-site-trails">Open site-linked money trails</a>
      </div>
      <div class="feature-grid">
        {placeInvestigationTrails.map((trail) => {
          const leadEntity = getLeadEntityProfileForTrail(trail);

          return (
            <InvestigationTrail
              kicker={trail.kicker}
              title={trail.title}
              summary={trail.summary}
              chips={trail.chips}
              tone={trail.tone}
              steps={trail.steps}
              footnote={trail.footnote}
              footerLinks={
                leadEntity
                  ? [{ href: `/entities/${leadEntity.entityId}/`, label: `Open ${leadEntity.entityName} profile` }]
                  : []
              }
            />
          );
        })}
      </div>
    </section>
  )}

  <section id="route-metrics" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Local route metrics</h2>
        <p class="lede">
          The area profile should show route composition, not force users to infer it from a single asylum count.
        </p>
      </div>
    </div>
    <div class="feature-grid">
      <article class="feature-card accent">
        <div class="chip-row">
          <span class="chip accent">Asylum support</span>
        </div>
        <h3>Accommodation split</h3>
        <div class="data-list">
          <div class="data-row">
            <span>Dispersal accommodation</span>
            <span class="data-row-value">{area.dispersalAccommodation.toLocaleString()}</span>
          </div>
          <div class="data-row">
            <span>Initial accommodation</span>
            <span class="data-row-value">{area.initialAccommodation.toLocaleString()}</span>
          </div>
          <div class="data-row">
            <span>Subsistence only</span>
            <span class="data-row-value">{area.subsistenceOnly.toLocaleString()}</span>
          </div>
          <div class="data-row">
            <span>Contingency accommodation</span>
            <span class="data-row-value">{area.contingencyAccommodation.toLocaleString()}</span>
          </div>
        </div>
      </article>

      <article class="feature-card">
        <div class="chip-row">
          <span class="chip teal">Ukraine and Afghan pathways</span>
        </div>
        <h3>Other current routes in this place</h3>
        <div class="data-list">
          <div class="data-row">
            <span>Homes for Ukraine arrivals</span>
            <span class="data-row-value">{area.homesForUkraineArrivals.toLocaleString()}</span>
          </div>
          <div class="data-row">
            <span>Afghan programme population</span>
            <span class="data-row-value">{area.afghanProgrammePopulation.toLocaleString()}</span>
          </div>
          <div class="data-row">
            <span>Afghan local authority housing</span>
            <span class="data-row-value">{area.afghanProgrammeLaHousing.toLocaleString()}</span>
          </div>
          <div class="data-row">
            <span>Afghan private rented housing</span>
            <span class="data-row-value">{area.afghanProgrammePrsHousing.toLocaleString()}</span>
          </div>
        </div>
      </article>

      <article class="feature-card">
        <div class="chip-row">
          <span class="chip">Historical routes</span>
        </div>
        <h3>Resettlement history</h3>
        <div class="data-list">
          <div class="data-row">
            <span>Resettlement cumulative total</span>
            <span class="data-row-value">{(area.resettlementCumulativeTotal ?? 0).toLocaleString()}</span>
          </div>
          <div class="data-row">
            <span>UK resettlement and family reunion cumulative</span>
            <span class="data-row-value">{area.ukResettlementFamilyCumulative.toLocaleString()}</span>
          </div>
          <div class="data-row">
            <span>Community sponsorship cumulative</span>
            <span class="data-row-value">{area.communitySponsorshipCumulative.toLocaleString()}</span>
          </div>
          <div class="data-row">
            <span>Latest resettlement quarter</span>
            <span class="data-row-value">
              {area.latestResettlementQuarterLabel} ({area.latestResettlementQuarterValue.toLocaleString()})
            </span>
          </div>
        </div>
      </article>
    </div>
  </section>

  <section id="regional-peers" class="split section section-anchor">
    <div class="panel panel-pad">
      <h2>Regional peer frame</h2>
      <p class="lede">
        The regional ranking matters because high-pressure areas compete for attention with their nearest peers, not
        just with the national top ten.
      </p>
      {regionalPeerRows.map((peer) => (
        <div class="metric-bar">
          <div style="min-width: 11rem;">
            <strong>{peer.areaName}</strong>
            <div class="tiny">
              {peer.areaCode === area.areaCode
                ? `Current page | ${peer.supportedAsylum.toLocaleString()} supported asylum`
                : `${peer.supportedAsylum.toLocaleString()} supported asylum`}
            </div>
          </div>
          <div class="metric-track">
            <div class="metric-fill" style={`width: ${(peer.supportedAsylum / regionalPeerMax) * 100}%`}></div>
          </div>
        </div>
      ))}
    </div>

    <article class="editor-note prose-stack">
      <div class="chip-row">
        <span class="chip accent">Local reading</span>
        <span class="chip">{area.regionName}</span>
      </div>
      <h3>How this place reads in context</h3>
      {editorialParagraphs.map((paragraph) => (
        <p>{paragraph}</p>
      ))}
    </article>
  </section>

  <section id="hotel-evidence" class="section section-anchor">
    <div class="section-head">
      <div>
        <h2>Hotel evidence for this place</h2>
        <p class="lede">
          Place pages should merge live route data with the named and unnamed hotel evidence already on the public
          record.
        </p>
      </div>
    </div>
    {hotelSites.length > 0 || hotelArea ? (
      <div class="table-card">
        <table>
          <caption>Public hotel evidence currently attached to {area.areaName}, including named sites and unnamed acknowledged use.</caption>
          <thead>
            <tr>
              <th scope="col">Site</th>
              <th scope="col">Status</th>
              <th scope="col">Evidence</th>
              <th scope="col">Last public date</th>
              <th scope="col">Entity coverage</th>
            </tr>
          </thead>
          <tbody>
            {hotelSites.map((site) => (
              (() => {
                const entityProfiles = getSiteEntityProfiles(site);

                return (
                  <tr>
                    <th scope="row">
                      <strong>{site.siteName}</strong>
                      <div class="tiny">
                        <a class="source-pill" href={site.sourceUrl}>Evidence</a>
                      </div>
                    </th>
                    <td>{site.status}</td>
                    <td>{site.evidenceClass}</td>
                    <td>{site.lastPublicDate}</td>
                    <td>
                      <div class="chip-row">
                        <span class="chip">{site.entityCoverage}</span>
                      </div>
                      {site.ownerName && <div class="tiny">Owner: {site.ownerName}</div>}
                      {site.operatorName && <div class="tiny">Operator: {site.operatorName}</div>}
                      {site.primeProvider && (
                        <div class="tiny">
                          Prime provider: {site.primeProvider.provider}
                          {getEntityProfileByReference(site.primeProvider.provider, null) && (
                            <>
                              {" "}
                              <a href={`/entities/${getEntityProfileByReference(site.primeProvider.provider, null)!.entityId}/`}>
                                profile
                              </a>
                            </>
                          )}
                        </div>
                      )}
                      {site.entityLinks.map((link) => {
                        const profile = getEntityProfileByReference(link.entityName, link.companyNumber);

                        return (
                          <div class="tiny">
                            {link.entityName} ({link.linkRole})
                            {profile && (
                              <>
                                {" "}
                                <a href={`/entities/${profile.entityId}/`}>profile</a>
                              </>
                            )}
                          </div>
                        );
                      })}
                      {site.entityLinks.length === 0 &&
                        !site.primeProvider &&
                        entityProfiles.length === 0 && <div class="tiny">No linked entity profile yet.</div>}
                    </td>
                  </tr>
                );
              })()
            ))}
            {hotelArea && hotelArea.unnamedSiteCount > 0 && (
              <tr>
                <th scope="row">
                  <strong>Unnamed sites</strong>
                  <div class="tiny">
                    <a class="source-pill" href={hotelArea.sourceUrl}>Source</a>
                  </div>
                </th>
                <td>acknowledged</td>
                <td>area sighting</td>
                <td>{hotelArea.lastPublicDate}</td>
                <td>
                  <span class="tiny">{hotelArea.unnamedSiteCount} site{hotelArea.unnamedSiteCount > 1 ? "s" : ""} without public names</span>
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    ) : (
      <article class="feature-card">
        <div class="chip-row">
          <span class="chip">Evidence gap</span>
        </div>
        <h3>No public hotel evidence logged yet</h3>
        <p class="lede">
          That does not mean the area has no hotel use. It means the ledger has no publishable public evidence row
          attached yet.
        </p>
      </article>
    )}
  </section>

  {hotelSignals.length > 0 && (
    <section id="integrity-signals" class="section section-anchor">
      <div class="section-head">
        <div>
          <h2>Integrity signals already visible</h2>
          <p class="lede">
            These signals are attached to publicly evidenced sites in this area. They are place-level accountability
            leads, not background noise.
          </p>
        </div>
      </div>
      <div class="story-grid">
        {hotelSignals.map((signal) => (
          <article class="story-card">
            <div class="chip-row">
              <span class={`chip ${signal.severity === "warning" ? "accent" : ""}`}>{signal.severity}</span>
              <span class="chip">{signal.siteName}</span>
            </div>
            <h3>{signal.headline ?? "Integrity signal"}</h3>
            {signal.detail && <p class="lede">{signal.detail}</p>}
          </article>
        ))}
      </div>
    </section>
  )}

  <script>
    import { initPlaceDrilldown } from "../../scripts/place-drilldown";

    initPlaceDrilldown();
  </script>
</BaseLayout>

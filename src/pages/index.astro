---
import BaseLayout from "../layouts/BaseLayout.astro";
import KpiCard from "../components/KpiCard.astro";
import overview from "../data/mock/overview.json";
import releases from "../data/mock/releases.json";

import asylumFinance from "../data/live/asylum-finance.json";
import { loadLocalRouteLatest, loadRouteDashboard } from "../lib/route-data";
import { loadHotelEntityLedger } from "../lib/hotel-data";
import { loadMoneyLedger } from "../lib/money-data";

const routeDashboard = loadRouteDashboard();
const localRouteLatest = loadLocalRouteLatest();
const hotelLedger = loadHotelEntityLedger();
const moneyLedger = loadMoneyLedger();
const routeCards = routeDashboard.nationalCards.slice(0, 4);
const topPlaces = localRouteLatest.topAreasByMetric.find((group) => group.metricId === "supportedAsylum")?.rows ?? [];
const maxSupport = Math.max(...topPlaces.map((place) => place.value), 1);
const namedCurrentHotels = hotelLedger.sites.filter((site) => site.status === "current");
const moneyPreview = moneyLedger.records.slice(0, 3);
const topAreas = localRouteLatest.areas
  .filter((a) => a.supportedAsylum >= 200)
  .sort((a, b) => b.supportedAsylum - a.supportedAsylum)
  .slice(0, 8);
const pressureLead = topAreas[0];
const featuredRouteSignal = routeCards[0];
const heroStats = [
  {
    label: "Areas tracked",
    value: localRouteLatest.areas.length.toLocaleString(),
    detail: `Official local-authority rows in the ${localRouteLatest.snapshotDate} snapshot.`
  },
  {
    label: "Current named hotels",
    value: namedCurrentHotels.length.toLocaleString(),
    detail: "Visible current sites in the public evidence ledger."
  },
  {
    label: "Money-ledger rows",
    value: moneyLedger.summary.totalRecords.toLocaleString(),
    detail: "Contracts, tariffs, scrutiny estimates, and local response rows."
  },
  {
    label: "Bodies and suppliers",
    value: moneyLedger.summary.uniqueSuppliers.toLocaleString(),
    detail: "Public bodies, providers, and linked entities with trackable exposure."
  }
];
---

<BaseLayout
  title="asylumstats | UK asylum accountability"
  description="UK asylum accountability site covering routes, hotel tracking, and public money."
>
  <section class="hero">
    <div class="hero-copy">
      <span class="kicker">{overview.hero.kicker}</span>
      <h1>{overview.hero.title}</h1>
      <p>{overview.hero.summary}</p>
      <div class="hero-actions">
        <a class="chip accent" href="/compare">Compare places</a>
        <a class="chip" href="/routes">Split routes</a>
        <a class="chip teal" href="/hotels">Track hotels</a>
        <a class="chip" href="/spending">Follow the money</a>
      </div>
      <div class="chip-row">
        <span class="chip">{localRouteLatest.snapshotDate} local snapshot</span>
        <span class="chip teal">
          {hotelLedger.summary.currentNamedSitesWithAnyEntityLinks} current hotel sites with entity links
        </span>
        <span class="chip accent">{hotelLedger.summary.currentNamedSitesUnresolved} unresolved current sites</span>
      </div>
    </div>

    <aside class="hero-panel">
      <div class="hero-panel-header">
        <div>
          <span class="tiny">Live accountability stack</span>
          <span class="hero-panel-title">Routes, hotels, and money on one source-linked surface.</span>
        </div>
        <span class="chip">Dec 2025</span>
      </div>

      <div class="hero-stat-grid">
        {heroStats.map((item) => (
          <article class="hero-stat">
            <span class="tiny">{item.label}</span>
            <strong>{item.value}</strong>
            <p class="tiny">{item.detail}</p>
          </article>
        ))}
      </div>

      {pressureLead && (
        <article class="hero-callout">
          <span class="tiny">Pressure leader</span>
          <strong>{pressureLead.areaName}</strong>
          <p class="lede">
            {pressureLead.supportedAsylum.toLocaleString()} people on asylum support, with{" "}
            {pressureLead.contingencyAccommodation.toLocaleString()} in contingency accommodation.
          </p>
        </article>
      )}

      {featuredRouteSignal && (
        <article class="hero-callout accent">
          <span class="tiny">National route signal</span>
          <strong>{featuredRouteSignal.label}</strong>
          <p class="lede">
            {featuredRouteSignal.valueSuffix
              ? `${featuredRouteSignal.value}${featuredRouteSignal.valueSuffix}`
              : featuredRouteSignal.value.toLocaleString()}{" "}
            in {featuredRouteSignal.period}.
          </p>
        </article>
      )}
    </aside>
  </section>

  <section class="section">
    <h2>Accountability snapshot</h2>
    <div class="kpi-grid">
      {overview.kpis.map((item) => (
        <KpiCard
          label={item.label}
          value={item.value}
          context={item.context}
          status={item.status}
          sourceUrl={item.sourceUrl}
        />
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Official route split now live</h2>
    <div class="kpi-grid">
      {routeCards.map((item) => (
        <article class="kpi-card">
          <span class="tiny">{item.label}</span>
          <strong>{item.valueSuffix ? `${item.value}${item.valueSuffix}` : item.value.toLocaleString()}</strong>
          <small>{item.period}</small>
          <p class="tiny">{item.detail}</p>
          <p class="tiny">
            <a class="source-pill" href={item.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Why this can hit harder than a normal dashboard</h2>
    <div class="story-grid">
      {overview.angles.map((angle) => (
        <article class="story-card">
          <h3>{angle.title}</h3>
          <p class="lede">{angle.body}</p>
          <p class="tiny">
            <a class="source-pill" href={angle.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>What counts as in scope</h2>
    <div class="story-grid">
      {asylumFinance.scopeRules.map((rule) => (
        <article class="story-card">
          <div class="chip-row">
            <span class={`chip ${rule.id === "route_specific" ? "accent" : rule.id === "local_route_relevant" ? "teal" : ""}`}>
              {rule.label}
            </span>
          </div>
          <p class="lede">{rule.description}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>What the product should split out</h2>
    <div class="story-grid">
      {asylumFinance.routeFamilies.slice(0, 6).map((route) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip accent">{route.group}</span>
          </div>
          <h3>{route.label}</h3>
          <p class="lede">{route.note}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section">
    <div class="panel" style="padding: 1.25rem;">
      <h2>Where pressure is concentrated</h2>
      <p class="lede">Latest official local-authority asylum-support snapshot as at 31 December 2025.</p>
      {topPlaces.map((place) => (
        <div class="metric-bar">
          <div style="min-width: 10rem;">
            <strong>{place.areaName}</strong>
            <div class="tiny">{place.value.toLocaleString()} supported people</div>
          </div>
          <div class="metric-track">
            <div class="metric-fill" style={`width: ${(place.value / maxSupport) * 100}%`}></div>
          </div>
        </div>
      ))}
    </div>

    <div class="panel" style="padding: 1.25rem;">
      <h2>Named current hotel sites with entity coverage</h2>
      <p class="lede">
        The public estate is only partially visible. This starter ledger shows which named current sites have owner or
        operator links and which still sit inside the secrecy gap.
      </p>
      <div class="story-grid">
        {namedCurrentHotels.map((site) => (
          <article class="metric-card">
            <div class="chip-row">
              <span class="chip accent">{site.evidenceClass}</span>
              <span class="chip">{site.entityCoverage}</span>
            </div>
            <h3>{site.siteName}</h3>
            <p class="lede">{site.areaName}</p>
            <p class="tiny">Owner: {site.ownerName ?? "Unresolved"}</p>
            <p class="tiny">Operator: {site.operatorName ?? "Unresolved"}</p>
            <p class="tiny">Last public evidence: {site.lastPublicDate}</p>
          </article>
        ))}
      </div>
    </div>
  </section>

  <section class="section">
    <h2>Top area pages</h2>
    <div class="place-grid">
      {topAreas.map((area) => (
        <article class="place-card">
          <div class="chip-row">
            <span class="chip">{area.regionName}</span>
            <span class="chip teal">{area.countryName}</span>
          </div>
          <h3>
            <a href={`/places/${area.areaCode}`}>{area.areaName}</a>
          </h3>
          <p class="lede">
            {area.supportedAsylum.toLocaleString()} people on asylum support as at {localRouteLatest.snapshotDate}.
          </p>
          <p class="tiny">
            Rate per 10,000: {area.supportedAsylumRate ?? "n/a"} | Contingency: {area.contingencyAccommodation.toLocaleString()}
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Public money layer now live</h2>
    <div class="story-grid">
      {moneyPreview.map((record) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip accent">{record.recordType.replace(/_/g, " ")}</span>
            {record.routeFamily && <span class="chip">{record.routeFamily}</span>}
          </div>
          <h3>{record.title}</h3>
          <p class="lede">
            {record.supplierName ? `${record.buyerName} -> ${record.supplierName}` : record.buyerName}
          </p>
          <p class="tiny">{record.periodLabel ?? "No period label recorded"}</p>
          <p class="tiny">
            <a class="source-pill" href="/spending">Open money ledger</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Release diary</h2>
    <div class="story-grid">
      {releases.map((release) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip">{release.date}</span>
          </div>
          <h3>{release.title}</h3>
          <p class="lede">{release.summary}</p>
          <p class="tiny">
            <a class="source-pill" href={release.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>

---
import BaseLayout from "../layouts/BaseLayout.astro";
import KpiCard from "../components/KpiCard.astro";
import RegionTileMap from "../components/RegionTileMap.astro";
import TrendChart from "../components/TrendChart.astro";
import overview from "../data/mock/overview.json";
import releases from "../data/mock/releases.json";

import asylumFinance from "../data/live/asylum-finance.json";
import { loadLocalRouteLatest, loadRouteDashboard } from "../lib/route-data";
import { loadHotelEntityLedger } from "../lib/hotel-data";
import { loadMoneyLedger } from "../lib/money-data";
import { getRegionPressureSummaries } from "../lib/route-analytics";

const routeDashboard = loadRouteDashboard();
const localRouteLatest = loadLocalRouteLatest();
const hotelLedger = loadHotelEntityLedger();
const moneyLedger = loadMoneyLedger();
const nationalSystemDynamics = routeDashboard.nationalSystemDynamics;
const routeCards = routeDashboard.nationalCards.slice(0, 4);
const homepageStockFlowCards = nationalSystemDynamics.stockFlowCards;
const homepagePostDecisionPath = nationalSystemDynamics.postDecisionPath;
const topPlaces = localRouteLatest.topAreasByMetric.find((group) => group.metricId === "supportedAsylum")?.rows ?? [];
const maxSupport = Math.max(...topPlaces.map((place) => place.value), 1);
const namedCurrentHotels = hotelLedger.sites.filter((site) => site.status === "current");
const moneyPreview = moneyLedger.records.slice(0, 3);
const topAreas = localRouteLatest.areas
  .filter((a) => a.supportedAsylum >= 200)
  .sort((a, b) => b.supportedAsylum - a.supportedAsylum)
  .slice(0, 8);
const pressureLead = topAreas[0];
const featuredRouteSignal = routeCards[0];
const smallBoatTrend = routeDashboard.routeFamilies.find((route) => route.id === "small_boats") ?? routeDashboard.routeFamilies[0];
const regionalPressure = getRegionPressureSummaries(localRouteLatest.areas);
const leadRegion = regionalPressure[0];
const heroStats = [
  {
    label: "Areas tracked",
    value: localRouteLatest.areas.length.toLocaleString(),
    detail: `Official local-authority rows in the ${localRouteLatest.snapshotDate} snapshot.`
  },
  {
    label: "Current named hotels",
    value: namedCurrentHotels.length.toLocaleString(),
    detail: "Visible current sites in the public evidence ledger."
  },
  {
    label: "Money-ledger rows",
    value: moneyLedger.summary.totalRecords.toLocaleString(),
    detail: "Contracts, tariffs, scrutiny estimates, and local response rows."
  },
  {
    label: "Bodies and suppliers",
    value: moneyLedger.summary.uniqueSuppliers.toLocaleString(),
    detail: "Public bodies, providers, and linked entities with trackable exposure."
  }
];
const guidedPaths = [
  {
    kicker: "Pressure map",
    title: "Start with places if you need to know where the load actually lands",
    body: "The compare and place pages turn national asylum headlines into local authority pressure, pathway mix, and contingency exposure.",
    href: "/compare",
    cta: "Open compare"
  },
  {
    kicker: "Secrecy gap",
    title: "Start with hotels if you need named sites, ownership gaps, and visible unresolved chains",
    body: "The hotel layer keeps current named sites, unnamed-only areas, and owner or operator evidence on one surface.",
    href: "/hotels",
    cta: "Open hotel tracker"
  },
  {
    kicker: "Money trail",
    title: "Start with spending if you need contract scope, tariff rows, and supplier exposure",
    body: "The money ledger separates prime contracts, funding instructions, and scrutiny cost rows instead of flattening them into one fake spend total.",
    href: "/spending",
    cta: "Open money ledger"
  },
  {
    kicker: "Source discipline",
    title: "Start with sources and methodology if you need to know what the site will and will not publish",
    body: "This product stays useful because route-specific evidence, local route relevance, and context-only research are kept separate.",
    href: "/sources",
    cta: "Open source ledger"
  }
];
const freshnessCards = [
  {
    label: "Routes mart built",
    value: routeDashboard.generatedAt,
    detail: `Local snapshot ${localRouteLatest.snapshotDate}`,
    href: "/routes"
  },
  {
    label: "Hotel ledger built",
    value: hotelLedger.generatedAt,
    detail: `${hotelLedger.summary.currentNamedSites.toLocaleString()} current named sites tracked`,
    href: "/hotels"
  },
  {
    label: "Money ledger built",
    value: moneyLedger.generatedAt,
    detail: `${moneyLedger.summary.totalRecords.toLocaleString()} public money rows in scope`,
    href: "/spending"
  },
  {
    label: "Latest release logged",
    value: releases[0]?.date,
    detail: releases[0]?.title ?? "No release logged",
    href: "/releases"
  }
];
const systemLogicCards = [
  {
    title: "Support is quarter-end stock, not throughput",
    body: nationalSystemDynamics.readingNotes[0]
  },
  {
    title: "Flat local lines can still hide churn",
    body:
      "A place hovering around the same support count can still be turning over people underneath that line because inflows and exits can offset each other."
  },
  {
    title: "Backlog and support overlap without matching",
    body: nationalSystemDynamics.readingNotes[1]
  },
  {
    title: "Appeals lag and returns are broader",
    body: `Appeals are asylum-specific but the latest machine-readable quarter is ${homepagePostDecisionPath.appeals.dataCompleteThroughLabel ?? "older"}. Returns are current to ${homepagePostDecisionPath.returns.latestQuarterLabel ?? "the latest quarter"}, but they cover all returns, not just asylum exits.`
  }
];

function formatUtcDate(iso: string | undefined): string {
  if (!iso) {
    return "n/a";
  }

  return new Intl.DateTimeFormat("en-GB", {
    day: "numeric",
    month: "short",
    year: "numeric",
    timeZone: "UTC"
  }).format(new Date(iso));
}

function formatUtcDateTime(iso: string | undefined): string {
  if (!iso) {
    return "n/a";
  }

  return new Intl.DateTimeFormat("en-GB", {
    day: "numeric",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    timeZone: "UTC",
    timeZoneName: "short"
  }).format(new Date(iso));
}
---

<BaseLayout
  title="asylumstats | UK asylum accountability"
  description="UK asylum accountability site covering routes, hotel tracking, public money, and local area pressure with source-linked evidence."
>
  <section class="hero">
    <div class="hero-copy">
      <span class="kicker">{overview.hero.kicker}</span>
      <h1>{overview.hero.title}</h1>
      <p>{overview.hero.summary}</p>
      <div class="hero-actions">
        <a class="chip accent" href="/compare">Compare places</a>
        <a class="chip" href="/routes">Split routes</a>
        <a class="chip teal" href="/hotels">Track hotels</a>
        <a class="chip" href="/spending">Follow the money</a>
      </div>
      <div class="chip-row">
        <span class="chip">{localRouteLatest.snapshotDate} local snapshot</span>
        <span class="chip teal">
          {hotelLedger.summary.currentNamedSitesWithAnyEntityLinks} current hotel sites with entity links
        </span>
        <span class="chip accent">{hotelLedger.summary.currentNamedSitesUnresolved} unresolved current sites</span>
      </div>
    </div>

    <aside class="hero-panel">
      <div class="hero-panel-header">
        <div>
          <span class="tiny">Live accountability stack</span>
          <span class="hero-panel-title">Routes, hotels, and money on one source-linked surface.</span>
        </div>
        <span class="chip">Dec 2025</span>
      </div>

      <div class="hero-stat-grid">
        {heroStats.map((item) => (
          <article class="hero-stat">
            <span class="tiny">{item.label}</span>
            <strong>{item.value}</strong>
            <p class="tiny">{item.detail}</p>
          </article>
        ))}
      </div>

      {pressureLead && (
        <article class="hero-callout">
          <span class="tiny">Pressure leader</span>
          <strong>{pressureLead.areaName}</strong>
          <p class="lede">
            {pressureLead.supportedAsylum.toLocaleString()} people on asylum support, with{" "}
            {pressureLead.contingencyAccommodation.toLocaleString()} in contingency accommodation.
          </p>
        </article>
      )}

      {featuredRouteSignal && (
        <article class="hero-callout accent">
          <span class="tiny">National route signal</span>
          <strong>{featuredRouteSignal.label}</strong>
          <p class="lede">
            {featuredRouteSignal.valueSuffix
              ? `${featuredRouteSignal.value}${featuredRouteSignal.valueSuffix}`
              : featuredRouteSignal.value.toLocaleString()}{" "}
            in {featuredRouteSignal.period}.
          </p>
        </article>
      )}
    </aside>
  </section>

  <section class="section section-anchor" id="start-here">
    <div class="section-head">
      <div>
        <h2>Start with the right surface</h2>
        <p class="lede">
          The site works best when readers pick the right layer first. Pressure, hotel secrecy, money, and source
          rules answer different questions.
        </p>
      </div>
      <a class="chip accent" href="/methodology">Why the scope rules matter</a>
    </div>
    <div class="guide-grid">
      {guidedPaths.map((path) => (
        <article class="guide-card">
          <div class="chip-row">
            <span class="chip accent">{path.kicker}</span>
          </div>
          <h3>{path.title}</h3>
          <p>{path.body}</p>
          <p class="tiny">
            <a class="source-pill" href={path.href}>{path.cta}</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section section-anchor" id="freshness">
    <article class="freshness-card">
      <div class="section-head">
        <div>
          <h2>Freshness ledger</h2>
          <p class="lede">
            National chapters, local authority tables, hotel evidence, and money rows do not update on one timetable.
          </p>
        </div>
      </div>
      <div class="freshness-list">
        {freshnessCards.map((item) => (
          <div class="freshness-row">
            <div>
              <strong>{item.label}</strong>
              <span class="tiny">{item.detail}</span>
            </div>
            <div class="freshness-meta">
              <time datetime={item.value}>{item.value?.includes("T") ? formatUtcDateTime(item.value) : formatUtcDate(item.value)}</time>
              <a class="source-pill" href={item.href}>Open</a>
            </div>
          </div>
        ))}
      </div>
    </article>

    <article class="editor-note">
      <div class="chip-row">
        <span class="chip accent">Editorial rule</span>
      </div>
      <h3>Do not let one update stream fake completeness</h3>
      <p>
        As of 28 February 2026, the national asylum chapters have already moved to the year ending December 2025,
        while the latest public local-authority tables still sit on the year ending September 2025. The homepage keeps
        that mismatch explicit so users do not mistake one fresh headline for a fully refreshed product.
      </p>
      <p class="tiny">
        <a class="source-pill" href="/releases">Open release diary</a>
      </p>
    </article>
  </section>

  <section class="section">
    <h2>Accountability snapshot</h2>
    <div class="kpi-grid">
      {overview.kpis.map((item) => (
        <KpiCard
          label={item.label}
          value={item.value}
          context={item.context}
          status={item.status}
          sourceUrl={item.sourceUrl}
        />
      ))}
    </div>
  </section>

  <section class="section section-anchor" id="system-logic">
    <div class="section-head">
      <div>
        <h2>How the system moves</h2>
        <p class="lede">
          The siteâ€™s main logic is that claims, decisions, backlog, support, appeals, and returns are different
          measures. Put them on one line and you lose the meaning.
        </p>
      </div>
      <a class="chip accent" href="/routes#post-decision-path">Open the full stock-flow model</a>
    </div>
    <div class="stat-strip">
      {homepageStockFlowCards.map((item) => (
        <article class="stat-tile">
          <span class="tiny">{item.label}</span>
          <strong>{item.valueSuffix ? `${item.value}${item.valueSuffix}` : item.value.toLocaleString()}</strong>
          <p class="tiny">{item.period}</p>
        </article>
      ))}
    </div>
    <div class="story-grid" style="margin-top: 1rem;">
      {systemLogicCards.map((card) => (
        <article class="story-card">
          <h3>{card.title}</h3>
          <p class="lede">{card.body}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Visual brief</h2>
        <p class="lede">
          The product now has static charts and map views that make concentration and change legible without adding a
          client-side charting dependency.
        </p>
      </div>
      <span class="chip">Built from live route marts</span>
    </div>
    <div class="viz-grid">
      <TrendChart
        points={smallBoatTrend.series.map((point) => ({ label: point.periodLabel, value: point.value }))}
        title={smallBoatTrend.label}
        description="Official annual series showing how the irregular arrival route changed from 2018 to 2025."
        tone="warm"
      />
      <RegionTileMap
        items={regionalPressure.map((region) => ({ regionName: region.regionName, value: region.supportedAsylum }))}
        title="Regional concentration of supported asylum"
        description={`${leadRegion.regionName} currently has the largest supported asylum total in the live local-authority snapshot.`}
        valueLabel="supported asylum total"
        highlightRegion={leadRegion?.regionName}
      />
    </div>
  </section>

  <section class="section">
    <h2>Official route split now live</h2>
    <div class="kpi-grid">
      {routeCards.map((item) => (
        <article class="kpi-card">
          <span class="tiny">{item.label}</span>
          <strong>{item.valueSuffix ? `${item.value}${item.valueSuffix}` : item.value.toLocaleString()}</strong>
          <small>{item.period}</small>
          <p class="tiny">{item.detail}</p>
          <p class="tiny">
            <a class="source-pill" href={item.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Why this can hit harder than a normal dashboard</h2>
    <div class="story-grid">
      {overview.angles.map((angle) => (
        <article class="story-card">
          <h3>{angle.title}</h3>
          <p class="lede">{angle.body}</p>
          <p class="tiny">
            <a class="source-pill" href={angle.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>What counts as in scope</h2>
    <div class="story-grid">
      {asylumFinance.scopeRules.map((rule) => (
        <article class="story-card">
          <div class="chip-row">
            <span class={`chip ${rule.id === "route_specific" ? "accent" : rule.id === "local_route_relevant" ? "teal" : ""}`}>
              {rule.label}
            </span>
          </div>
          <p class="lede">{rule.description}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>What the product should split out</h2>
    <div class="story-grid">
      {asylumFinance.routeFamilies.slice(0, 6).map((route) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip accent">{route.group}</span>
          </div>
          <h3>{route.label}</h3>
          <p class="lede">{route.note}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section">
    <div class="panel" style="padding: 1.25rem;">
      <h2>Where pressure is concentrated</h2>
      <p class="lede">
        Latest official local-authority asylum-support snapshot as at 31 December 2025. These are end-of-period stock
        counts, not the number of different people who moved through the system over the year, and not a one-line
        substitute for the awaiting-decision backlog.
      </p>
      {topPlaces.map((place) => (
        <div class="metric-bar">
          <div style="min-width: 10rem;">
            <strong>{place.areaName}</strong>
            <div class="tiny">{place.value.toLocaleString()} supported people</div>
          </div>
          <div class="metric-track">
            <div class="metric-fill" style={`width: ${(place.value / maxSupport) * 100}%`}></div>
          </div>
        </div>
      ))}
    </div>

    <div class="panel" style="padding: 1.25rem;">
      <h2>Named current hotel sites with entity coverage</h2>
      <p class="lede">
        The public estate is only partially visible. This starter ledger shows which named current sites have owner or
        operator links and which still sit inside the secrecy gap.
      </p>
      <div class="story-grid">
        {namedCurrentHotels.map((site) => (
          <article class="metric-card">
            <div class="chip-row">
              <span class="chip accent">{site.evidenceClass}</span>
              <span class="chip">{site.entityCoverage}</span>
            </div>
            <h3>{site.siteName}</h3>
            <p class="lede">{site.areaName}</p>
            <p class="tiny">Owner: {site.ownerName ?? "Unresolved"}</p>
            <p class="tiny">Operator: {site.operatorName ?? "Unresolved"}</p>
            <p class="tiny">Last public evidence: {site.lastPublicDate}</p>
          </article>
        ))}
      </div>
    </div>
  </section>

  <section class="section">
    <h2>Top area pages</h2>
    <div class="place-grid">
      {topAreas.map((area) => (
        <article class="place-card">
          <div class="chip-row">
            <span class="chip">{area.regionName}</span>
            <span class="chip teal">{area.countryName}</span>
          </div>
          <h3>
            <a href={`/places/${area.areaCode}`}>{area.areaName}</a>
          </h3>
          <p class="lede">
            {area.supportedAsylum.toLocaleString()} people on asylum support at quarter end as at {localRouteLatest.snapshotDate}.
          </p>
          <p class="tiny">
            Rate per 10,000: {area.supportedAsylumRate ?? "n/a"} | Contingency: {area.contingencyAccommodation.toLocaleString()}
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Public money layer now live</h2>
    <div class="story-grid">
      {moneyPreview.map((record) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip accent">{record.recordType.replace(/_/g, " ")}</span>
            {record.routeFamily && <span class="chip">{record.routeFamily}</span>}
          </div>
          <h3>{record.title}</h3>
          <p class="lede">
            {record.supplierName ? `${record.buyerName} -> ${record.supplierName}` : record.buyerName}
          </p>
          <p class="tiny">{record.periodLabel ?? "No period label recorded"}</p>
          <p class="tiny">
            <a class="source-pill" href="/spending">Open money ledger</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Release diary</h2>
    <div class="story-grid">
      {releases.map((release) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip">{release.date}</span>
          </div>
          <h3>{release.title}</h3>
          <p class="lede">{release.summary}</p>
          <p class="tiny">
            <a class="source-pill" href={release.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>

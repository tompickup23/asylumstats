---
import BaseLayout from "../layouts/BaseLayout.astro";
import KpiCard from "../components/KpiCard.astro";
import RegionTileMap from "../components/RegionTileMap.astro";
import TrendChart from "../components/TrendChart.astro";
import overview from "../data/mock/overview.json";
import releases from "../data/mock/releases.json";

import { loadLocalRouteLatest, loadRouteDashboard } from "../lib/route-data";
import { loadHotelEntityLedger } from "../lib/hotel-data";
import { loadMoneyLedger } from "../lib/money-data";
import { getRegionPressureSummaries } from "../lib/route-analytics";

const routeDashboard = loadRouteDashboard();
const localRouteLatest = loadLocalRouteLatest();
const hotelLedger = loadHotelEntityLedger();
const moneyLedger = loadMoneyLedger();
type MoneyRecordWithValue = (typeof moneyLedger.records)[number] & { valueGbp: number };
const nationalSystemDynamics = routeDashboard.nationalSystemDynamics;
const routeCards = routeDashboard.nationalCards.slice(0, 4);
const homepageStockFlowCards = nationalSystemDynamics.stockFlowCards;
const homepagePostDecisionPath = nationalSystemDynamics.postDecisionPath;
const topPlaces = localRouteLatest.topAreasByMetric.find((group) => group.metricId === "supportedAsylum")?.rows ?? [];
const maxSupport = Math.max(...topPlaces.map((place) => place.value), 1);
const namedCurrentHotels = hotelLedger.sites.filter((site) => site.status === "current");
const unnamedOnlyAreas = hotelLedger.areas.filter((area) => area.visibilityClass === "all_unnamed");
const leadUnnamedArea = unnamedOnlyAreas[0];
const hotelPreviewSites = namedCurrentHotels.slice(0, 4);
const leadMoneyRecord = moneyLedger.records
  .filter((record): record is MoneyRecordWithValue => typeof record.valueGbp === "number")
  .sort((a, b) => b.valueGbp - a.valueGbp)[0];
const moneyPreview = moneyLedger.records
  .filter((record): record is MoneyRecordWithValue => typeof record.valueGbp === "number")
  .sort((a, b) => b.valueGbp - a.valueGbp)
  .slice(0, 3);
const leadSupplier = moneyLedger.supplierProfiles[0];
const primaryMoneyLead = moneyLedger.investigativeLeads[0];
const topAreas = localRouteLatest.areas
  .filter((a) => a.supportedAsylum >= 200)
  .sort((a, b) => b.supportedAsylum - a.supportedAsylum)
  .slice(0, 8);
const pressureLead = topAreas[0];
const featuredRouteSignal = routeCards[0];
const smallBoatTrend = routeDashboard.routeFamilies.find((route) => route.id === "small_boats") ?? routeDashboard.routeFamilies[0];
const regionalPressure = getRegionPressureSummaries(localRouteLatest.areas);
const leadRegion = regionalPressure[0];
const heroStats = [
  {
    label: "Areas tracked",
    value: localRouteLatest.areas.length.toLocaleString(),
    detail: `Official local-authority rows in the ${localRouteLatest.snapshotDate} snapshot.`
  },
  {
    label: "Current named hotels",
    value: namedCurrentHotels.length.toLocaleString(),
    detail: "Visible current sites in the public evidence ledger."
  },
  {
    label: "Money-ledger rows",
    value: moneyLedger.summary.totalRecords.toLocaleString(),
    detail: "Contracts, tariffs, scrutiny estimates, and local response rows."
  },
  {
    label: "Bodies and suppliers",
    value: moneyLedger.summary.uniqueSuppliers.toLocaleString(),
    detail: "Public bodies, providers, and linked entities with trackable exposure."
  }
];
const guidedPaths = [
  {
    kicker: "Secrecy gap",
    title: "Hotels first if you want the sharpest public accountability failure",
    body: "The hotel tracker leads with unresolved chains, unnamed-only areas, and archive-led verification so the hidden estate lands before the methodology.",
    href: "/hotels",
    cta: "Open hotels"
  },
  {
    kicker: "Money trail",
    title: "Money second if you want the contract rows and supplier exposure underneath the estate",
    body: "The spending page now opens with investigative leads, largest disclosed rows, buyer concentration, and supplier watchlists before the full ledger.",
    href: "/spending",
    cta: "Open money"
  },
  {
    kicker: "Pressure map",
    title: "Pressure next if you need to see where the load is landing locally",
    body: "Compare and place pages show which authorities carry the heaviest stock, rates, contingency use, and pathway mix.",
    href: "/compare",
    cta: "Open pressure view"
  },
  {
    kicker: "System logic",
    title: "Routes and stock-flow logic come after the estate and money layers",
    body: "The routes page explains why support is stock, not throughput, and why appeals and returns have to be kept in separate lanes.",
    href: "/routes",
    cta: "Open routes"
  }
];
const freshnessCards = [
  {
    label: "Routes mart built",
    value: routeDashboard.generatedAt,
    detail: `Local snapshot ${localRouteLatest.snapshotDate}`,
    href: "/routes"
  },
  {
    label: "Hotel ledger built",
    value: hotelLedger.generatedAt,
    detail: `${hotelLedger.summary.currentNamedSites.toLocaleString()} current named sites tracked`,
    href: "/hotels"
  },
  {
    label: "Money ledger built",
    value: moneyLedger.generatedAt,
    detail: `${moneyLedger.summary.totalRecords.toLocaleString()} public money rows in scope`,
    href: "/spending"
  },
  {
    label: "Latest release logged",
    value: releases[0]?.date,
    detail: releases[0]?.title ?? "No release logged",
    href: "/releases"
  }
];
const systemLogicCards = [
  {
    title: "Support is quarter-end stock, not throughput",
    body: nationalSystemDynamics.readingNotes[0]
  },
  {
    title: "Flat local lines can still hide churn",
    body:
      "A place hovering around the same support count can still be turning over people underneath that line because inflows and exits can offset each other."
  },
  {
    title: "Backlog and support overlap without matching",
    body: nationalSystemDynamics.readingNotes[1]
  },
  {
    title: "Appeals lag and returns are broader",
    body: `Appeals are asylum-specific but the latest machine-readable quarter is ${homepagePostDecisionPath.appeals.dataCompleteThroughLabel ?? "older"}. Returns are current to ${homepagePostDecisionPath.returns.latestQuarterLabel ?? "the latest quarter"}, but they cover all returns, not just asylum exits.`
  }
];
const homepagePriorityCards = [
  {
    kicker: "Hidden estate",
    title: `${hotelLedger.summary.currentNamedSitesUnresolved} current named hotels still have unresolved ownership or operator chains`,
    body: `${hotelLedger.summary.unnamedOnlyAreaCount} areas publicly acknowledge hotel use without naming the sites, and ${hotelLedger.archiveVerification.pendingVerificationCount} archive leads are still waiting for document-backed verification.`,
    detail: leadUnnamedArea
      ? `${leadUnnamedArea.areaName} is one of the clearest live examples of the secrecy gap.`
      : "The public estate remains only partly visible.",
    href: "/hotels#unresolved-watchlist",
    cta: "Open hotel findings",
    tone: "accent"
  },
  {
    kicker: "Money trail",
    title: primaryMoneyLead?.title ?? "The money layer already exposes contract concentration",
    body:
      primaryMoneyLead?.detail ??
      "The spending page now starts with the rows, buyers, and suppliers that matter before dropping into the full ledger.",
    detail:
      leadMoneyRecord && leadSupplier
        ? `${leadMoneyRecord.title} is one of the largest disclosed rows at ${formatMoney(leadMoneyRecord.valueGbp)}, and ${leadSupplier.entityName} is already attached to ${leadSupplier.publicContractCount} public money rows.`
        : "The contract layer is still partial, but the concentration is already visible.",
    href: "/spending#money-findings",
    cta: "Open money findings",
    tone: "accent"
  },
  pressureLead
    ? {
        kicker: "Pressure",
        title: `${pressureLead.areaName} shows how local pressure can stay high without telling you who rotated through`,
        body: `${pressureLead.supportedAsylum.toLocaleString()} people were on asylum support there at quarter end, with ${pressureLead.contingencyAccommodation.toLocaleString()} in contingency accommodation.`,
        detail: "These are quarter-end stock counts. A flat local line can still hide churn underneath it.",
        href: "/compare#compare-findings",
        cta: "Open pressure findings",
        tone: ""
      }
    : null
].filter(
  (
    card
  ): card is {
    kicker: string;
    title: string;
    body: string;
    detail: string;
    href: string;
    cta: string;
    tone: string;
  } => card !== null
);

function formatUtcDate(iso: string | undefined): string {
  if (!iso) {
    return "n/a";
  }

  return new Intl.DateTimeFormat("en-GB", {
    day: "numeric",
    month: "short",
    year: "numeric",
    timeZone: "UTC"
  }).format(new Date(iso));
}

function formatMoney(value: number | null | undefined): string {
  if (typeof value !== "number") {
    return "No published value";
  }

  return new Intl.NumberFormat("en-GB", {
    style: "currency",
    currency: "GBP",
    maximumFractionDigits: value >= 1000 ? 0 : 2
  }).format(value);
}

function formatUtcDateTime(iso: string | undefined): string {
  if (!iso) {
    return "n/a";
  }

  return new Intl.DateTimeFormat("en-GB", {
    day: "numeric",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    timeZone: "UTC",
    timeZoneName: "short"
  }).format(new Date(iso));
}
---

<BaseLayout
  title="asylumstats | UK asylum accountability"
  description="UK asylum accountability site covering routes, hotel tracking, public money, and local area pressure with source-linked evidence."
>
  <section class="hero">
    <div class="hero-copy">
      <span class="kicker">{overview.hero.kicker}</span>
      <h1>{overview.hero.title}</h1>
      <p>{overview.hero.summary}</p>
      <div class="hero-actions">
        <a class="chip accent" href="/hotels">Track hotels first</a>
        <a class="chip" href="/spending">Follow the money</a>
        <a class="chip teal" href="/compare">See local pressure</a>
        <a class="chip" href="/routes">Check stock and flow</a>
      </div>
      <div class="chip-row">
        <span class="chip">{localRouteLatest.snapshotDate} local snapshot</span>
        <span class="chip teal">
          {hotelLedger.summary.currentNamedSitesWithAnyEntityLinks} current hotel sites with entity links
        </span>
        <span class="chip accent">{hotelLedger.summary.currentNamedSitesUnresolved} unresolved current sites</span>
      </div>
    </div>

    <aside class="hero-panel">
      <div class="hero-panel-header">
        <div>
          <span class="tiny">Live accountability stack</span>
          <span class="hero-panel-title">Hotels, supplier exposure, and local pressure on one source-linked surface.</span>
        </div>
        <span class="chip">Dec 2025</span>
      </div>

      <div class="hero-stat-grid">
        {heroStats.map((item) => (
          <article class="hero-stat">
            <span class="tiny">{item.label}</span>
            <strong>{item.value}</strong>
            <p class="tiny">{item.detail}</p>
          </article>
        ))}
      </div>

      {pressureLead && (
        <article class="hero-callout">
          <span class="tiny">Pressure leader</span>
          <strong>{pressureLead.areaName}</strong>
          <p class="lede">
            {pressureLead.supportedAsylum.toLocaleString()} people on asylum support, with{" "}
            {pressureLead.contingencyAccommodation.toLocaleString()} in contingency accommodation.
          </p>
        </article>
      )}

      {featuredRouteSignal && (
        <article class="hero-callout accent">
          <span class="tiny">National route signal</span>
          <strong>{featuredRouteSignal.label}</strong>
          <p class="lede">
            {featuredRouteSignal.valueSuffix
              ? `${featuredRouteSignal.value}${featuredRouteSignal.valueSuffix}`
              : featuredRouteSignal.value.toLocaleString()}{" "}
            in {featuredRouteSignal.period}.
          </p>
        </article>
      )}
    </aside>
  </section>

  <section class="section section-anchor priority-section" id="read-this-first">
    <div class="section-head">
      <div>
        <h2>Read this first</h2>
        <p class="lede">
          {pressureLead
            ? `${hotelLedger.summary.currentNamedSitesUnresolved} current named hotels still lack a resolved owner or operator chain, ${hotelLedger.summary.unnamedOnlyAreaCount} areas acknowledge hotel use without naming the sites, and ${pressureLead.areaName} was carrying ${pressureLead.supportedAsylum.toLocaleString()} people on asylum support at quarter end.`
            : `${hotelLedger.summary.currentNamedSitesUnresolved} current named hotels still lack a resolved owner or operator chain, and ${hotelLedger.summary.unnamedOnlyAreaCount} areas acknowledge hotel use without naming the sites.`}
        </p>
      </div>
      <a class="chip accent" href="/hotels#unresolved-watchlist">Open the sharpest evidence trail</a>
    </div>
    <div class="feature-grid">
      {homepagePriorityCards.map((card, index) => (
        <article class={`feature-card priority-card${card.tone ? ` ${card.tone}` : ""}`}>
          <span class="priority-rank">{String(index + 1).padStart(2, "0")}</span>
          <div class="chip-row">
            <span class="chip accent">{card.kicker}</span>
          </div>
          <h3>{card.title}</h3>
          <p class="lede">{card.body}</p>
          <p class="tiny">{card.detail}</p>
          <p class="tiny">
            <a class="source-pill" href={card.href}>{card.cta}</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section evidence-preview">
    <div class="panel panel-pad evidence-panel evidence-panel-hotels">
      <div class="section-head">
        <div>
          <h2>Open hotel evidence now</h2>
          <p class="lede">{hotelLedger.summary.currentNamedSitesUnresolved} current named sites still stop short of a resolved chain even after public naming.</p>
        </div>
        <a class="source-pill" href="/hotels#hotel-ledger">Open hotel ledger</a>
      </div>
      <div class="story-grid">
        {hotelPreviewSites.map((site) => (
          <article class="story-card">
            <div class="chip-row">
              <span class="chip accent">{site.entityCoverage}</span>
              <span class="chip">{site.evidenceClass}</span>
            </div>
            <h3>{site.siteName}</h3>
            <p class="lede">{site.areaName}</p>
            <p class="tiny">Owner: {site.ownerName ?? "Unresolved"}</p>
            <p class="tiny">Operator: {site.operatorName ?? "Unresolved"}</p>
            <p class="tiny">Last public evidence: {site.lastPublicDate}</p>
          </article>
        ))}
      </div>
    </div>

    <div class="panel panel-pad evidence-panel evidence-panel-money">
      <div class="section-head">
        <div>
          <h2>Open money evidence now</h2>
          <p class="lede">
            {leadMoneyRecord
              ? `${leadMoneyRecord.title} is already public at ${formatMoney(leadMoneyRecord.valueGbp)}. The problem is control and comparability, not the absence of a money trail.`
              : "Large public rows are already visible. The problem is control and comparability, not the absence of a money trail."}
          </p>
        </div>
        <a class="source-pill" href="/spending#money-findings">Open money findings</a>
      </div>
      <div class="story-grid">
        {moneyPreview.map((record) => (
          <article class="story-card">
            <div class="chip-row">
              <span class="chip accent">{record.recordType.replace(/_/g, " ")}</span>
              {record.routeFamily && <span class="chip">{record.routeFamily}</span>}
            </div>
            <h3>{record.title}</h3>
            <p class="lede">{formatMoney(record.valueGbp)}</p>
            <p class="tiny">
              {record.supplierName ? `${record.buyerName} -> ${record.supplierName}` : record.buyerName}
            </p>
            <p class="tiny">{record.periodLabel ?? "No period label recorded"}</p>
          </article>
        ))}
      </div>
    </div>
  </section>

  <section class="section section-anchor" id="start-here">
    <div class="section-head">
      <div>
        <h2>Then widen out</h2>
        <p class="lede">
          Once the key findings are clear, these are the four main surfaces that let users move from scandal to system.
        </p>
      </div>
      <a class="chip accent" href="/sources">Open the source ledger</a>
    </div>
    <div class="guide-grid">
      {guidedPaths.map((path) => (
        <article class="guide-card">
          <div class="chip-row">
            <span class="chip accent">{path.kicker}</span>
          </div>
          <h3>{path.title}</h3>
          <p>{path.body}</p>
          <p class="tiny">
            <a class="source-pill" href={path.href}>{path.cta}</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section section-anchor" id="freshness">
    <article class="freshness-card">
      <div class="section-head">
        <div>
          <h2>Freshness ledger</h2>
          <p class="lede">
            National chapters, local authority tables, hotel evidence, and money rows do not update on one timetable.
          </p>
        </div>
      </div>
      <div class="freshness-list">
        {freshnessCards.map((item) => (
          <div class="freshness-row">
            <div>
              <strong>{item.label}</strong>
              <span class="tiny">{item.detail}</span>
            </div>
            <div class="freshness-meta">
              <time datetime={item.value}>{item.value?.includes("T") ? formatUtcDateTime(item.value) : formatUtcDate(item.value)}</time>
              <a class="source-pill" href={item.href}>Open</a>
            </div>
          </div>
        ))}
      </div>
    </article>

    <article class="editor-note">
      <div class="chip-row">
        <span class="chip accent">Editorial rule</span>
      </div>
      <h3>Do not let one update stream fake completeness</h3>
      <p>
        As of 28 February 2026, the national asylum chapters have already moved to the year ending December 2025,
        while the latest public local-authority tables still sit on the year ending September 2025. The homepage keeps
        that mismatch explicit so users do not mistake one fresh headline for a fully refreshed product.
      </p>
      <p class="tiny">
        <a class="source-pill" href="/releases">Open release diary</a>
      </p>
    </article>
  </section>

  <section class="section">
    <h2>National snapshot</h2>
    <div class="kpi-grid">
      {overview.kpis.map((item) => (
        <KpiCard
          label={item.label}
          value={item.value}
          context={item.context}
          status={item.status}
          sourceUrl={item.sourceUrl}
        />
      ))}
    </div>
  </section>

  <section class="section section-anchor" id="system-logic">
    <div class="section-head">
      <div>
        <h2>How the system moves</h2>
        <p class="lede">
          The siteâ€™s main logic is that claims, decisions, backlog, support, appeals, and returns are different
          measures. Put them on one line and you lose the meaning.
        </p>
      </div>
      <a class="chip accent" href="/routes#post-decision-path">Open the full stock-flow model</a>
    </div>
    <div class="stat-strip">
      {homepageStockFlowCards.map((item) => (
        <article class="stat-tile">
          <span class="tiny">{item.label}</span>
          <strong>{item.valueSuffix ? `${item.value}${item.valueSuffix}` : item.value.toLocaleString()}</strong>
          <p class="tiny">{item.period}</p>
        </article>
      ))}
    </div>
    <div class="story-grid" style="margin-top: 1rem;">
      {systemLogicCards.map((card) => (
        <article class="story-card">
          <h3>{card.title}</h3>
          <p class="lede">{card.body}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <div>
        <h2>Visual brief</h2>
        <p class="lede">
          The product now has static charts and map views that make concentration and change legible without adding a
          client-side charting dependency.
        </p>
      </div>
      <span class="chip">Built from live route marts</span>
    </div>
    <div class="viz-grid">
      <TrendChart
        points={smallBoatTrend.series.map((point) => ({ label: point.periodLabel, value: point.value }))}
        title={smallBoatTrend.label}
        description="Official annual series showing how the irregular arrival route changed from 2018 to 2025."
        tone="warm"
      />
      <RegionTileMap
        items={regionalPressure.map((region) => ({ regionName: region.regionName, value: region.supportedAsylum }))}
        title="Regional concentration of supported asylum"
        description={`${leadRegion.regionName} currently has the largest supported asylum total in the live local-authority snapshot.`}
        valueLabel="supported asylum total"
        highlightRegion={leadRegion?.regionName}
      />
    </div>
  </section>

  <section class="section">
    <h2>Why the current evidence matters</h2>
    <div class="story-grid">
      {overview.angles.map((angle) => (
        <article class="story-card">
          <h3>{angle.title}</h3>
          <p class="lede">{angle.body}</p>
          <p class="tiny">
            <a class="source-pill" href={angle.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="split section">
    <div class="panel" style="padding: 1.25rem;">
      <h2>Where pressure is landing</h2>
      <p class="lede">
        Latest official local-authority asylum-support snapshot as at 31 December 2025. These are end-of-period stock
        counts, not the number of different people who moved through the system over the year, and not a one-line
        substitute for the awaiting-decision backlog.
      </p>
      {topPlaces.map((place) => (
        <div class="metric-bar">
          <div style="min-width: 10rem;">
            <strong>{place.areaName}</strong>
            <div class="tiny">{place.value.toLocaleString()} supported people</div>
          </div>
          <div class="metric-track">
            <div class="metric-fill" style={`width: ${(place.value / maxSupport) * 100}%`}></div>
          </div>
        </div>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Top area pages</h2>
    <div class="place-grid">
      {topAreas.map((area) => (
        <article class="place-card">
          <div class="chip-row">
            <span class="chip">{area.regionName}</span>
            <span class="chip teal">{area.countryName}</span>
          </div>
          <h3>
            <a href={`/places/${area.areaCode}`}>{area.areaName}</a>
          </h3>
          <p class="lede">
            {area.supportedAsylum.toLocaleString()} people on asylum support at quarter end as at {localRouteLatest.snapshotDate}.
          </p>
          <p class="tiny">
            Rate per 10,000: {area.supportedAsylumRate ?? "n/a"} | Contingency: {area.contingencyAccommodation.toLocaleString()}
          </p>
        </article>
      ))}
    </div>
  </section>

  <section class="section">
    <h2>Release diary</h2>
    <div class="story-grid">
      {releases.map((release) => (
        <article class="story-card">
          <div class="chip-row">
            <span class="chip">{release.date}</span>
          </div>
          <h3>{release.title}</h3>
          <p class="lede">{release.summary}</p>
          <p class="tiny">
            <a class="source-pill" href={release.sourceUrl}>Source</a>
          </p>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>
